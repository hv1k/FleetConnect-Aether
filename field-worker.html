<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script>
      // Theme init - prevent flash of wrong theme
      (function(){
        var t = localStorage.getItem('fleetconnect-theme');
        if(t === 'light') document.documentElement.classList.add('light-mode');
      })();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Jobs | FleetConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="voice-notes.js" defer></script>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FleetConnect">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #100e20; color: #ede9fe; min-height: 100vh; }
        .layout { display: flex; min-height: 100vh; }

        /* Sidebar */
        nav { flex: 1; overflow-y: auto; }

        /* Navigate Button */
        .btn-navigate { background: rgba(34,197,94,0.15) !important; color: #34d399 !important; border: 1px solid rgba(34,197,94,0.3) !important; }
        .btn-navigate:hover { background: rgba(34,197,94,0.25) !important; }

        /* Navigation Menu */
        .nav-menu { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .nav-menu-item { display: block; width: 100%; padding: 12px 16px; background: transparent; border: none; color: #ede9fe; text-align: left; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.9rem; transition: all 0.2s; border-bottom: 1px solid #333; }
        .nav-menu-item:last-child { border-bottom: none; }
        .nav-menu-item:hover { background: #333; color: #8b5cf6; }

        /* Digital Signature */
        .signature-section { margin-top: 20px; background: #181530; border-radius: 12px; padding: 16px; border: 1px solid #333; }
        .signature-section .section-title { margin-top: 0; margin-bottom: 8px; }
        .signature-canvas-wrap { position: relative; background: #fff; border-radius: 8px; overflow: hidden; margin-bottom: 8px; }
        .signature-canvas-wrap canvas { display: block; width: 100%; touch-action: none; cursor: crosshair; }
        .signature-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #ccc; font-size: 0.85rem; pointer-events: none; }
        .signature-actions { display: flex; gap: 8px; }
        .signature-actions button { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #444; background: #333; color: #ede9fe; font-size: 0.8rem; cursor: pointer; }
        .signature-actions button:hover { background: #444; }
        .signature-status { text-align: center; margin-top: 8px; font-size: 0.8rem; color: #34d399; display: none; }
        .signature-status.show { display: block; }
        /* Mobile sidebar toggle */
        .mobile-toggle { display: none; background: none; border: none; color: #ede9fe; cursor: pointer; padding: 4px; }
        .admin-sidebar { width: 260px; background: #181530; border-right: 1px solid #333; padding: 24px 16px; position: fixed; left: 0; top: 0; height: 100vh; overflow-y: auto; z-index: 99; display: flex; flex-direction: column; }
        .admin-sidebar-logo { font-size: 1.1rem; font-weight: 700; color: #8b5cf6; margin-bottom: 16px; }
        .admin-nav-section { margin-bottom: 24px; }
        .admin-nav-section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #888; padding: 0 12px; margin-bottom: 8px; letter-spacing: 0.5px; }
        .admin-nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; color: #8b85b0; text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; cursor: pointer; margin-bottom: 4px; }
        .admin-nav-item:hover { background: #333; color: #ede9fe; }
        .admin-nav-item.active { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        .admin-nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
        .admin-sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid #333; }
        .admin-sidebar nav { flex: 1; overflow-y: auto; }
        .main-content { flex: 1; margin-left: 260px; }

        @media (max-width: 768px) {
            .admin-sidebar { left: -260px; transition: left 0.3s; }
            .admin-sidebar.open { left: 0; box-shadow: 4px 0 20px rgba(0,0,0,0.5); }
            .main-content { margin-left: 0 !important; }
            .mobile-toggle { display: block; }
        }

        /* Main */
        .header { padding: 24px 32px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header h1 { font-size: 1.4rem; font-weight: 700; }
        .header-subtitle { font-size: 0.85rem; color: #888; margin-top: 2px; }
        .content { padding: 24px 32px; }

        /* Stats row */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #181530; border: 1px solid #333; border-radius: 14px; padding: 18px 20px; }
        .stat-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #888; letter-spacing: 0.3px; display: flex; align-items: center; gap: 6px; }
        .stat-label svg { width: 15px; height: 15px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: #ede9fe; margin-top: 6px; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab { flex: 1; padding: 14px; background: transparent; border: none; border-bottom: 2px solid transparent; color: #888; font-family: 'Poppins', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; text-align: center; transition: all 0.2s; }
        .tab:hover { color: #ede9fe; }
        .tab.active { color: #8b5cf6; border-bottom-color: #8b5cf6; }

        /* Job Cards */
        .job-card { background: #181530; border: 1px solid #333; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .job-card.urgent { border-left: 4px solid #fbbf24; }
        .job-header { padding: 16px; border-bottom: 1px solid #333; }
        .job-title { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
        .job-meta { font-size: 0.8rem; color: #888; }
        .job-info { padding: 12px 16px; background: #1e1e1e; }
        .job-info-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.85rem; }
        .job-info-label { color: #666; }
        .job-info-value { color: #ede9fe; }
        .job-info-value a { color: #8b5cf6; text-decoration: none; }
        .equipment-count { padding: 12px 16px; font-size: 0.85rem; color: #8b5cf6; border-top: 1px solid #333; }
        .job-actions { padding: 12px 16px; display: flex; gap: 10px; }

        .btn { flex: 1; padding: 12px; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 600; border-radius: 8px; cursor: pointer; text-align: center; border: none; }
        .btn-primary { background: #8b5cf6; color: #100e20; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-outline { background: transparent; color: #888; border: 1px solid #333; }
        .btn-outline:hover { background: #333; color: #ede9fe; }

        .empty { text-align: center; padding: 60px 20px; color: #888; font-size: 0.9rem; }
        .empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.4; }

        /* Invoice Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; }
        .modal-content { background: #100e20; min-height: 100%; padding: 20px; padding-bottom: 120px; max-width: 700px; margin: 0 auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #181530; border-radius: 12px; margin-bottom: 20px; position: sticky; top: 0; z-index: 10; }
        .modal-header h2 { font-size: 1.1rem; }
        .modal-close { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 4px 8px; }
        .modal-close:hover { color: #ede9fe; }

        .job-site-info { background: #181530; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .job-site-name { font-weight: 600; font-size: 1.1rem; margin-bottom: 4px; }
        .job-site-address { font-size: 0.85rem; color: #888; }

        .section-title { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #8b5cf6; margin-bottom: 12px; margin-top: 24px; }

        /* Unit Cards */
        .unit-card { background: #181530; border: 1px solid #333; border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
        .unit-card.active { border-color: #8b5cf6; }
        .unit-header { padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .unit-info { display: flex; align-items: center; gap: 12px; }
        .unit-checkbox { width: 24px; height: 24px; border: 2px solid #333; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .unit-card.active .unit-checkbox { background: #8b5cf6; border-color: #8b5cf6; }
        .unit-card.active .unit-checkbox::after { content: '✓'; color: #100e20; font-weight: bold; font-size: 14px; }
        .unit-number { font-weight: 600; color: #8b5cf6; }
        .unit-desc { font-size: 0.85rem; color: #888; }
        .unit-toggle { color: #666; font-size: 0.8rem; }

        .unit-fields { display: none; padding: 16px; border-top: 1px solid #333; background: #1e1e1e; }
        .unit-card.active .unit-fields { display: block; }

        .field-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .field-group label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 4px; text-transform: uppercase; }
        .field-group input { width: 100%; padding: 12px; background: #181530; border: 1px solid #333; border-radius: 8px; color: #ede9fe; font-family: 'Poppins', sans-serif; font-size: 1rem; text-align: center; }
        .field-group input:focus { outline: none; border-color: #8b5cf6; }
        .field-group .unit-label { font-size: 0.7rem; color: #666; text-align: center; margin-top: 2px; }

        /* Invoice Details */
        .invoice-details { background: #181530; border: 1px solid #333; border-radius: 12px; padding: 16px; margin-top: 20px; }
        .detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .detail-group label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 6px; }
        .detail-group input, .detail-group textarea { width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #333; border-radius: 8px; color: #ede9fe; font-family: 'Poppins', sans-serif; }
        .detail-group input:focus, .detail-group textarea:focus { outline: none; border-color: #8b5cf6; }
        .detail-group textarea { min-height: 70px; resize: vertical; }

        /* Incident */
        .incident-toggle { display: flex; align-items: center; gap: 12px; padding: 14px; background: #1e1e1e; border-radius: 10px; cursor: pointer; margin-top: 16px; }
        .incident-toggle input { display: none; }
        .toggle-switch { width: 48px; height: 26px; background: #333; border-radius: 13px; position: relative; transition: background 0.3s; flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: transform 0.3s; }
        .incident-toggle input:checked + .toggle-switch { background: #fbbf24; }
        .incident-toggle input:checked + .toggle-switch::after { transform: translateX(22px); }
        .incident-fields { display: none; padding: 16px; background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 10px; margin-top: 12px; }
        .incident-fields.show { display: block; }
        .incident-fields h4 { color: #fbbf24; font-size: 0.9rem; margin-bottom: 12px; }
        .file-upload { border: 2px dashed #333; border-radius: 10px; padding: 16px; text-align: center; cursor: pointer; margin-bottom: 10px; }
        .file-upload:hover { border-color: #8b5cf6; }
        .file-upload input { display: none; }
        .file-upload-text { font-size: 0.85rem; color: #888; }
        .file-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .file-preview-item { position: relative; width: 60px; height: 60px; border-radius: 8px; overflow: hidden; }
        .file-preview-item img, .file-preview-item video { width: 100%; height: 100%; object-fit: cover; }
        .file-preview-item .remove { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: #f87171; border: none; border-radius: 50%; color: white; font-size: 10px; cursor: pointer; }

        /* Summary */
        .invoice-summary { background: #181530; border: 1px solid #8b5cf6; border-radius: 12px; padding: 16px; margin-top: 20px; }
        .summary-title { font-size: 0.8rem; color: #8b5cf6; text-transform: uppercase; margin-bottom: 12px; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; }
        .summary-row:last-child { border-bottom: none; font-weight: 600; }
        .summary-label { color: #888; }
        .summary-value { font-weight: 600; }

        .submit-invoice { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 660px; padding: 16px; background: #8b5cf6; color: #100e20; border: none; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 1rem; font-weight: 600; cursor: pointer; z-index: 100; }
        .submit-invoice:hover { background: #7c3aed; }
        .submit-invoice:disabled { opacity: 0.6; cursor: not-allowed; }

        /* History */
        .history-invoice { background: #181530; border: 1px solid #333; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .history-header { padding: 14px 16px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .history-date { font-weight: 600; }
        .history-worker { font-size: 0.85rem; color: #888; }
        .history-units { padding: 12px 16px; }
        .history-unit { display: flex; justify-content: space-between; padding: 10px; background: #1e1e1e; border-radius: 8px; margin-bottom: 8px; }
        .history-unit:last-child { margin-bottom: 0; }
        .history-unit-number { font-weight: 600; color: #8b5cf6; }
        .history-unit-details { font-size: 0.85rem; color: #888; text-align: right; }
        .history-totals { padding: 12px 16px; background: #1e1e1e; border-top: 1px solid #333; display: flex; justify-content: space-around; }
        .history-total { text-align: center; }
        .history-total-value { font-size: 1.1rem; font-weight: 700; color: #8b5cf6; }
        .history-total-label { font-size: 0.7rem; color: #666; text-transform: uppercase; }
        .history-incident { margin: 12px 16px; padding: 12px; background: rgba(251,191,36,0.1); border: 1px solid #fbbf24; border-radius: 8px; }
        .history-incident-title { color: #fbbf24; font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; }
        .history-incident-desc { font-size: 0.85rem; color: #888; }
        .history-incident-media { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .history-incident-media img, .history-incident-media video { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; cursor: pointer; }

        /* GPS Location Tracker */
        .gps-section { background: #181530; border: 1px solid #333; border-radius: 12px; padding: 16px; margin-top: 20px; }
        .gps-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .gps-title { font-size: 0.9rem; font-weight: 600; color: #ede9fe; }
        .gps-button { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #333; border: 1px solid #444; border-radius: 8px; color: #888; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; flex: 1; }
        .gps-button:hover:not(.gps-button.disabled) { background: #3d3d3d; border-color: #555; color: #ede9fe; }
        .gps-button.disabled { opacity: 0.6; cursor: not-allowed; }
        .gps-button.capturing { background: rgba(139, 92, 246, 0.15); border-color: #8b5cf6; color: #8b5cf6; }
        .gps-button.success { background: rgba(34, 197, 94, 0.15); border-color: #34d399; color: #34d399; }
        .gps-button.error { background: rgba(239, 68, 68, 0.15); border-color: #f87171; color: #f87171; }
        .gps-icon { width: 18px; height: 18px; flex-shrink: 0; }
        .gps-status { padding: 12px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333; margin-top: 12px; display: none; }
        .gps-status.show { display: block; }
        .gps-status.success { border-color: #34d399; background: rgba(34, 197, 94, 0.05); }
        .gps-status.error { border-color: #f87171; background: rgba(239, 68, 68, 0.05); }
        .gps-coords { font-size: 0.85rem; color: #ede9fe; font-family: 'Courier New', monospace; margin-bottom: 6px; }
        .gps-coords-label { font-size: 0.7rem; color: #666; text-transform: uppercase; margin-bottom: 4px; }
        .gps-coords-value { display: flex; justify-content: space-between; align-items: center; }
        .gps-map-link { display: inline-block; margin-top: 8px; padding: 6px 10px; background: #8b5cf6; color: #100e20; border-radius: 6px; text-decoration: none; font-size: 0.8rem; font-weight: 600; text-align: center; flex: 1; max-width: 100px; }
        .gps-map-link:hover { background: #7c3aed; }
        .gps-error-msg { font-size: 0.85rem; color: #f87171; margin-bottom: 0; }
        .gps-success-msg { font-size: 0.85rem; color: #34d399; display: flex; align-items: center; gap: 6px; }

        /* Toast */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 10px; font-size: 0.85rem; font-weight: 500; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
        .toast.success { background: #34d399; color: #fff; }
        .toast.error { background: #f87171; color: #fff; }

        /* Priority Badge */
        .priority-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-left: 8px; }
        .priority-badge.high { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.4); }
        .priority-badge.medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.4); }
        .priority-badge.low { background: rgba(34, 197, 94, 0.2); color: #34d399; border: 1px solid rgba(34, 197, 94, 0.4); }

        /* No Address Styling */
        .no-address { color: #666; font-style: italic; }

        /* Enhanced Signature Modal */
        .signature-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: flex; flex-direction: column; }
        .signature-modal-header { padding: 16px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #100e20; }
        .signature-modal-header h3 { font-size: 1rem; color: #ede9fe; margin: 0; }
        .signature-modal-close { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 4px 8px; }
        .signature-modal-close:hover { color: #ede9fe; }
        .signature-modal-canvas { flex: 1; display: flex; align-items: center; justify-content: center; background: #fff; }
        .signature-modal-canvas canvas { width: 100%; height: 100%; display: block; touch-action: none; cursor: crosshair; }
        .signature-modal-footer { padding: 16px; background: #100e20; border-top: 1px solid #333; display: flex; gap: 8px; }
        .signature-modal-footer button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; }
        .sig-btn-clear { background: #333; color: #888; }
        .sig-btn-clear:hover { background: #444; color: #ede9fe; }
        .sig-btn-done { background: #8b5cf6; color: #100e20; }
        .sig-btn-done:hover { background: #7c3aed; }

        /* Photo Upload Section */
        .photo-upload-section { background: #181530; border: 1px solid #333; border-radius: 12px; padding: 16px; margin-top: 20px; }
        .photo-upload-title { font-size: 0.9rem; font-weight: 600; color: #ede9fe; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .photo-required-badge { color: #f87171; font-size: 1rem; }
        .camera-button-group { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 16px; }
        .camera-button { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 16px; background: #333; border: 2px solid #444; border-radius: 10px; color: #ede9fe; font-family: 'Poppins', sans-serif; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .camera-button:hover { background: #3d3d3d; border-color: #8b5cf6; color: #8b5cf6; }
        .camera-button:active { transform: scale(0.98); }
        .camera-button svg { width: 20px; height: 20px; }
        .photo-categories { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .photo-category { background: #1e1e1e; padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .photo-category-label { font-size: 0.8rem; font-weight: 600; color: #8b5cf6; text-transform: uppercase; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .photo-category-required { color: #f87171; }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .photo-thumbnail { position: relative; width: 100%; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: #333; border: 2px solid #333; }
        .photo-thumbnail img, .photo-thumbnail video { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumbnail-delete { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: #f87171; border: none; border-radius: 50%; color: white; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .photo-thumbnail-delete:hover { background: #dc2626; }
        .photo-input-hidden { display: none; }

        /* Mobile Camera Optimization */
        @media (max-width: 768px) {
          .camera-button { padding: 16px; font-size: 1rem; }
          .photo-grid { grid-template-columns: repeat(2, 1fr); }
        }
    
        /* Light Mode */
        .light-mode { --bg-dark: #f5f5f5; --bg-card: #ffffff; --bg-input: #e8e8e8; --bg-hover: #e8e8e8; --border: #d0d0d0; --text-primary: #100e20; --text-secondary: #555555; --text-muted: #888888; }
        .light-mode .admin-sidebar { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .admin-sidebar-logo { color: #7c3aed !important; }
        .light-mode .admin-nav-item { color: #555555 !important; }
        .light-mode .admin-nav-item:hover { background: #e8e8e8 !important; color: #100e20 !important; }
        .light-mode .admin-nav-item.active { background: rgba(139, 92, 246, 0.15) !important; color: #7c3aed !important; }
        .light-mode .admin-nav-section { color: #888888 !important; }
        .light-mode .user-menu { background: #e8e8e8 !important; }
        .light-mode .user-name { color: #100e20 !important; }
        .light-mode .header { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .header h1 { color: #100e20 !important; }
        .light-mode .header-subtitle { color: #555555 !important; }
        .light-mode .main-content, .light-mode .content, .light-mode .admin-main { background: #f5f5f5 !important; }
        .light-mode .card, .light-mode .stat-card, .light-mode .metric-card, .light-mode .admin-card { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .card-title, .light-mode .stat-label { color: #100e20 !important; }
        .light-mode .card-subtitle { color: #555555 !important; }
        .light-mode input, .light-mode textarea, .light-mode select { background: #e8e8e8 !important; border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode input::placeholder, .light-mode textarea::placeholder { color: #888888 !important; }
        .light-mode .form-label, .light-mode label { color: #100e20 !important; }
        .light-mode .badge { background: rgba(139, 92, 246, 0.15) !important; color: #7c3aed !important; }
        .light-mode .btn-secondary { background: #e8e8e8 !important; color: #100e20 !important; border-color: #d0d0d0 !important; }
        .light-mode .btn-secondary:hover { background: #d0d0d0 !important; }
        .light-mode .admin-sidebar-footer { border-color: #d0d0d0 !important; }
        .light-mode .logout-btn:hover { background: #e8e8e8 !important; }
        .light-mode table th { background: #e8e8e8 !important; color: #100e20 !important; border-color: #d0d0d0 !important; }
        .light-mode table td { border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode table tr:hover { background: #e8e8e8 !important; }
        .light-mode .modal-overlay { background: rgba(0,0,0,0.3) !important; }
        .light-mode .modal, .light-mode .modal-content { background: #ffffff !important; border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode .notification-bell { color: #555555 !important; }
        .light-mode .search-box, .light-mode .search-input { background: #e8e8e8 !important; border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode .tab, .light-mode .tab-btn { color: #555555 !important; }
        .light-mode .tab.active, .light-mode .tab-btn.active { color: #7c3aed !important; border-color: #7c3aed !important; }
        .light-mode .dropdown, .light-mode .dropdown-menu { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .dropdown-item:hover { background: #e8e8e8 !important; }
        .light-mode .toggle-switch { background: #d0d0d0 !important; }
        .light-mode .toggle-switch.active { background: #7c3aed !important; }
        .light-mode .tooltip { background: #100e20 !important; color: #ffffff !important; }
        .light-mode .progress-bar { background: #e8e8e8 !important; }
        .light-mode .empty-state { color: #555555 !important; }
        .light-mode .filter-bar, .light-mode .toolbar { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .chip { background: #e8e8e8 !important; color: #100e20 !important; }
        .light-mode pre, .light-mode code { background: #e8e8e8 !important; color: #100e20 !important; }
        .light-mode .status-badge { border-color: #d0d0d0 !important; }
        .light-mode ::selection { background: #7c3aed; color: #ffffff; }
        .light-mode ::-webkit-scrollbar-track { background: #f5f5f5; }
        .light-mode ::-webkit-scrollbar-thumb { background: #d0d0d0; }
        .light-mode ::-webkit-scrollbar-thumb:hover { background: #bbbbbb; }

        .theme-toggle { background: none; border: 1px solid var(--border); border-radius: 8px; padding: 8px; cursor: pointer; color: var(--text-primary); font-size: 1.2rem; transition: all 0.2s; line-height: 1; }
        .theme-toggle:hover { background: var(--bg-hover); }

        
/* ===== AETHER THEME — Modern Light SaaS ===== */
:root {
    --bg-page: #f8f9fc;
    --bg-card: #ffffff;
    --bg-input: #f1f3f9;
    --accent: #0066ff;
    --accent-light: #e6f0ff;
    --text-primary: #1a1a2e;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --border: #e5e7eb;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    width: 100%;
    height: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background-color: var(--bg-page);
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ===== TOP NAVIGATION BAR ===== */
.aether-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 56px;
    background-color: var(--bg-card);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 32px;
    gap: 48px;
    z-index: 1000;
    box-shadow: var(--shadow);
}

.aether-navbar-logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 18px;
    color: var(--text-primary);
    text-decoration: none;
    flex-shrink: 0;
}

.aether-navbar-logo svg {
    width: 32px;
    height: 32px;
}

.aether-navbar-center {
    display: flex;
    align-items: center;
    gap: 32px;
    flex: 1;
}

.aether-nav-link {
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    padding: 0 4px;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    position: relative;
}

.aether-nav-link:hover {
    color: var(--accent);
}

.aether-nav-link.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

.aether-dropdown {
    position: relative;
}

.aether-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    min-width: 200px;
    margin-top: 8px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: all 0.2s ease;
    box-shadow: var(--shadow);
    z-index: 1001;
}

.aether-dropdown:hover .aether-dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.aether-dropdown-item {
    display: block;
    width: 100%;
    padding: 10px 16px;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.15s ease;
    border-left: 3px solid transparent;
}

.aether-dropdown-item:hover {
    background-color: var(--bg-input);
    color: var(--accent);
    border-left-color: var(--accent);
}

.aether-navbar-right {
    display: flex;
    align-items: center;
    gap: 24px;
    flex-shrink: 0;
}

.aether-user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.aether-user-avatar:hover {
    box-shadow: 0 2px 8px rgba(0, 102, 255, 0.2);
}

.aether-notification-bell {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background-color: var(--bg-input);
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.aether-notification-bell:hover {
    background-color: var(--accent-light);
    border-color: var(--accent);
}

.aether-notification-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background-color: var(--error);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 11px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Mobile hamburger */
.aether-hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
}

.aether-hamburger span {
    width: 24px;
    height: 2px;
    background-color: var(--text-primary);
    border-radius: 2px;
    transition: all 0.3s ease;
}

/* ===== MAIN CONTENT AREA ===== */
.main-content {
    padding-top: 56px;
    width: 100%;
    min-height: 100vh;
    background-color: var(--bg-page);
}

.content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 32px;
}

/* ===== CARDS ===== */
.card {
    background-color: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow);
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-card, .analytics-card, .table-card, .admin-card, .metric-card {
    background-color: var(--bg-card) !important;
    border: 1px solid var(--border) !important;
    border-radius: 12px !important;
    box-shadow: var(--shadow) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    padding: 24px !important;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.card-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

/* ===== TABLES ===== */
table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background-color: var(--bg-input);
}

th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border);
}

td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

tbody tr:hover {
    background-color: #f0f4ff;
}

/* ===== BUTTONS ===== */
.btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background-color: var(--accent);
    color: white;
}

.btn-primary:hover {
    background-color: #0052cc;
    box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
}

.btn-primary:active {
    transform: translateY(1px);
}

.btn-secondary {
    background-color: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    background-color: #e8ecf7;
    border-color: var(--accent);
}

.btn-danger {
    background-color: var(--error);
    color: white;
}

.btn-danger:hover {
    background-color: #dc2626;
}

.btn-success {
    background-color: var(--success);
    color: white;
}

.btn-success:hover {
    background-color: #059669;
}

.btn-small {
    padding: 6px 12px;
    font-size: 13px;
}

/* ===== FORMS ===== */
.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-primary);
}

input, textarea, select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    background-color: var(--bg-card);
    color: var(--text-primary);
    transition: all 0.2s ease;
}

input::placeholder, textarea::placeholder {
    color: var(--text-muted);
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
}

textarea {
    resize: vertical;
    min-height: 100px;
}

/* ===== STATS ===== */
.stat-value {
    font-size: 32px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 12px 0;
}

.stat-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-trend {
    font-size: 13px;
    font-weight: 500;
    color: var(--success);
    margin-top: 8px;
}

.stat-trend.negative {
    color: var(--error);
}

/* ===== BADGES ===== */
.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.badge-primary {
    background-color: var(--accent-light);
    color: var(--accent);
}

.badge-success {
    background-color: #d1fae5;
    color: var(--success);
}

.badge-warning {
    background-color: #fef3c7;
    color: var(--warning);
}

.badge-error {
    background-color: #fee2e2;
    color: var(--error);
}

.role-badge, .status-badge {
    border-radius: 20px !important;
}

/* ===== MODALS ===== */
.modal {
    background-color: var(--bg-card) !important;
    border: 1px solid var(--border) !important;
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

.modal-header {
    border-bottom: 1px solid var(--border);
    padding: 20px 24px;
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    border-top: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* ===== ALERTS ===== */
.alert {
    padding: 12px 16px;
    border-radius: 8px;
    border-left: 4px solid;
    margin-bottom: 16px;
}

.alert-success {
    background-color: #d1fae5;
    border-left-color: var(--success);
    color: #065f46;
}

.alert-warning {
    background-color: #fef3c7;
    border-left-color: var(--warning);
    color: #78350f;
}

.alert-error {
    background-color: #fee2e2;
    border-left-color: var(--error);
    color: #7f1d1d;
}

.alert-info {
    background-color: var(--accent-light);
    border-left-color: var(--accent);
    color: #003d99;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-page);
}

::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .aether-navbar {
        padding: 0 16px;
        gap: 24px;
    }

    .aether-navbar-center {
        display: none;
    }

    .aether-hamburger {
        display: flex;
    }

    .content-wrapper {
        padding: 16px;
    }

    .aether-dropdown-menu {
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        border-radius: 0;
        min-width: unset;
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
    }

    .aether-dropdown:hover .aether-dropdown-menu {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }
}

/* Remove sidebar styles from Aurora */
.admin-sidebar {
    display: none !important;
}

.sidebar {
    display: none !important;
}

.admin-sidebar-logo {
    display: none !important;
}

.admin-nav-section {
    display: none !important;
}

.admin-nav-item {
    display: none !important;
}

.brand-panel::after {
    content: none !important;
}

/* Remove Aurora theme styling */
body::before {
    display: none !important;
}

.orb, .orb-1, .orb-2 {
    display: none !important;
}
</style>

<style>

/* ===== AURORA THEME — Glassmorphism Purple/Teal ===== */
/* Glass card effect */
.stat-card, .analytics-card, .table-card, .admin-card, .metric-card {
    background: rgba(24, 21, 48, 0.6) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    border: 1px solid rgba(139, 92, 246, 0.12) !important;
    border-radius: 16px !important;
}

.admin-nav-item {
    border-radius: 12px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}
.admin-nav-item:hover {
    background: rgba(139, 92, 246, 0.08) !important;
    transform: translateX(4px);
}
.admin-nav-item.active {
    background: rgba(139, 92, 246, 0.15) !important;
    color: #8b5cf6 !important;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.08);
}
.btn-primary, .btn {
    border-radius: 12px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}
.btn-primary:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 30px rgba(139, 92, 246, 0.3) !important;
}
input, textarea, select {
    border-radius: 12px !important;
    transition: all 0.25s ease !important;
}
input:focus, textarea:focus, select:focus {
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15), 0 0 30px rgba(139, 92, 246, 0.05) !important;
}
.modal {
    border-radius: 20px !important;
    background: rgba(24, 21, 48, 0.9) !important;
    backdrop-filter: blur(24px) !important;
    -webkit-backdrop-filter: blur(24px) !important;
    border: 1px solid rgba(139, 92, 246, 0.15) !important;
}
/* Gradient accents */
.brand-panel::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #8b5cf6, #14b8a6, transparent);
}
.header h1, .admin-sidebar-logo {
    background: linear-gradient(135deg, #8b5cf6, #14b8a6) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(16, 14, 32, 0.5); }
::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.5); }
/* Status badges */
.role-badge, .status-badge { border-radius: 20px !important; }
/* Animated background pulse */
body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at 30% 70%, rgba(139, 92, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(20, 184, 166, 0.02) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
    animation: auroraPulse 20s ease-in-out infinite;
}
@keyframes auroraPulse {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(-5%, 5%) scale(1.02); }
    50% { transform: translate(5%, -5%) scale(0.98); }
    75% { transform: translate(-3%, -3%) scale(1.01); }
}

</style>
</head>
<body>
<nav id="aetherNavbar"></nav>

    <div class="layout">
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-logo">FLEETCONNECT</div>
<nav id="sidebarNav"></nav>
            <div class="admin-sidebar-footer">
                <div style="padding: 12px; background: #333; border-radius: 8px;">
                    <div style="font-size: 0.8rem; font-weight: 600; color: #ede9fe; margin-bottom: 4px;" id="adminUserName">User</div>
                    <div class="admin-sidebar-role" style="font-size: 0.75rem; color: #888;">Field Worker</div>
                    <button onclick="logout()" style="margin-top: 8px; width: 100%; padding: 6px; background: transparent; border: 1px solid #333; color: #888; border-radius: 6px; font-family: 'Poppins', sans-serif; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;">Logout</button>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-toggle" onclick="document.querySelector('.admin-sidebar').classList.toggle('open')"><svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
                    <div>
                        <h1 id="headerGreeting">My Jobs</h1>
                        <p class="header-subtitle">Manage your assigned work orders</p>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Stats -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-label"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Active Jobs</div>
                        <div class="stat-value" id="statActive" style="color:#34d399;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Invoices Today</div>
                        <div class="stat-value" id="statInvoices" style="color:#8b5cf6;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Completed</div>
                        <div class="stat-value" id="statCompleted" style="color:#fbbf24;">-</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="active">Active Jobs</button>
                    <button class="tab" data-tab="completed">Completed</button>
                </div>

                <!-- Jobs List -->
                <div id="jobsList">
                    <div class="empty">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="supabase-client.js"></script>
    <script src="sidebar.js"></script>
    <script src="feature-flags.js"></script>
    <script src="notifications.js"></script>
    <script src="realtime.js"></script>
    <script src="onboarding.js"></script>
    <script src="offline-sync.js"></script>
    <script src="pwa-register.js"></script>
    <script>
        const currentUser = checkAuth(['fieldworker']);
        if (!currentUser) throw new Error('Not authenticated');

        // Initialize feature flags for field worker role
        FC_FLAGS.init('fieldworker');

        // Service worker registration handled by pwa-register.js

        // Setup user info
        var _un = document.getElementById('adminUserName'); if (_un) _un.textContent = currentUser.name;
        var roleEl = document.querySelector('.admin-sidebar-role'); if (roleEl) roleEl.textContent = currentUser.role === 'fieldworker' ? 'Field Worker' : currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        const hour = new Date().getHours();
        const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
        var _head = document.getElementById('headerGreeting'); if(_head) _head.textContent = `${greeting}, ${currentUser.name.split(' ')[0]}!`;

        // Sidebar nav
        let allJobs = [];
        let allEquipment = [];
        let allInvoices = [];
        let currentTab = 'active';
        let selectedPhotos = [];
        let selectedVideos = [];
        let activeUnits = {};
        let capturedGPS = null;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        async function loadData() {
            try {
                // Only load jobs assigned to this worker — no fallback to all jobs
                allJobs = await getJobsByWorker(currentUser.id);
                allEquipment = await getAllEquipment();
                allInvoices = await getAllWorkerInvoices();
                updateStats();
                renderJobs();
            } catch (err) {
                console.error('Load error:', err);
                var _jobs = document.getElementById('jobsList'); if(_jobs) _jobs.innerHTML = '<div class="empty"><h3>Error loading data</h3><p>' + (err.message || 'Please try refreshing the page.') + '</p></div>';
            }
        }

        async function getAllEquipment() {
            const { data } = await db.from('equipment').select('*');
            return data || [];
        }

        async function getAllWorkerInvoices() {
            // Only get invoices created by this worker
            const { data } = await db.from('invoices').select('*')
                .eq('worker_id', currentUser.id)
                .order('created_at', { ascending: false });
            return data || [];
        }

        function updateStats() {
            // Count active jobs from rendered job cards
            const activeJobs = allJobs.filter(j => ['assigned','accepted','in-progress'].includes(j.status));
            const completedJobs = allJobs.filter(j => j.status === 'completed');

            // Update stats to match the rendered count
            const renderedActive = document.querySelectorAll('.job-card').length;
            const displayActiveCount = currentTab === 'active' ? renderedActive : activeJobs.length;

            var _stat = document.getElementById('statActive'); if(_stat) _stat.textContent = activeJobs.length;
            var _stat = document.getElementById('statCompleted'); if(_stat) _stat.textContent = completedJobs.length;

            // Only count invoices actually created today
            const today = new Date().toDateString();
            const todayInvoices = allInvoices.filter(inv => new Date(inv.created_at).toDateString() === today);
            var _stat = document.getElementById('statInvoices'); if(_stat) _stat.textContent = todayInvoices.length;
        }

        function getEquipmentForJob(jobId) {
            return allEquipment.filter(e => e.job_id === jobId);
        }

        function getInvoicesForJob(jobId) {
            return allInvoices.filter(inv => inv.job_id === jobId);
        }

        function getPriorityBadge(priority, job) {
            const p = (priority || '').toLowerCase();

            // If priority is explicitly set, use it
            if (p === 'urgent' || p === 'emergency') {
                return { class: 'high', text: '⚠ Urgent' };
            } else if (p === 'high') {
                return { class: 'high', text: '⚠ Urgent' };
            } else if (p === 'low') {
                return { class: 'low', text: '✓ Low' };
            }

            // Explicitly return Normal for "normal" or "medium" priority
            if (p === 'normal' || p === 'medium') {
                return { class: 'medium', text: '⭐ Normal' };
            }

            // Heuristics only if priority is completely empty/null
            if (job) {
                const now = new Date();
                const created = new Date(job.created_at);
                const updated = new Date(job.updated_at || job.created_at);
                const diffMs = now - created;
                const diffUpdateMs = now - updated;

                // URGENT: job created today or status changed in last 2 hours
                if (diffMs < 24 * 60 * 60 * 1000 || diffUpdateMs < 2 * 60 * 60 * 1000) {
                    return { class: 'high', text: '🔴 Urgent' };
                }

                // LOW: job older than 7 days with no recent activity
                if (diffMs > 7 * 24 * 60 * 60 * 1000 && diffUpdateMs > 7 * 24 * 60 * 60 * 1000) {
                    return { class: 'low', text: '⚪ Low' };
                }
            }

            // NORMAL: default
            return { class: 'medium', text: '🔵 Normal' };
        }

        function contactVendor(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            if (!job) return;

            const vendorEmail = job.vendor_email || 'vendor@fleetconnect.com';
            const subject = encodeURIComponent(`Address Update Needed - ${job.job_site_name || 'Job ' + jobId}`);
            const body = encodeURIComponent(`Hi,\n\nI'm working on job "${job.job_site_name || 'Untitled'}" but the address is missing from the system. Could you please update the address?\n\nThank you!`);
            window.location.href = `mailto:${vendorEmail}?subject=${subject}&body=${body}`;
            showToast('Opening email client...', 'success');
        }

        function renderJobs() {
            const filtered = currentTab === 'active'
                ? allJobs.filter(j => ['assigned','accepted','in-progress'].includes(j.status))
                : allJobs.filter(j => j.status === 'completed');

            const container = document.getElementById('jobsList');

            if (!filtered.length) {
                container.innerHTML = `<div class="empty">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <p>No ${currentTab} jobs${currentTab === 'active' ? ' assigned to you' : ''}</p>
                </div>`;
                var _stat = document.getElementById('statActive'); if(_stat) _stat.textContent = 0;
                return;
            }

            // Update active jobs count after rendering
            if (currentTab === 'active') {
                var _stat = document.getElementById('statActive'); if(_stat) _stat.textContent = filtered.length;
            }

            container.innerHTML = filtered.map(job => {
                const equipment = getEquipmentForJob(job.id);
                const invoices = getInvoicesForJob(job.id);
                const hasAddress = job.address_street || job.address_city;
                const badge = getPriorityBadge(job.priority, job);
                return `
                    <div class="job-card ${job.priority === 'urgent' || job.priority === 'emergency' ? 'urgent' : ''}">
                        <div class="job-header">
                            <div class="job-title">${safe(job.job_site_name || 'Untitled Job')}</div>
                            <div class="job-meta">${formatJobType(job.job_type)}<span class="priority-badge ${badge.class}">${badge.text}</span> • ${invoices.length} invoice${invoices.length !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="job-info">
                            <div class="job-info-row">
                                <span class="job-info-label">Location</span>
                                <span class="job-info-value">
                                    ${hasAddress ? `
                                        <a href="https://maps.google.com/?q=${encodeURIComponent((job.address_street||'')+' '+(job.address_city||'')+' '+(job.address_state||''))}" target="_blank">
                                            ${safe(job.address_city || '')}, ${safe(job.address_state || '')}
                                        </a>
                                    ` : `<span class="no-address">${safe(job.customer_name || 'Address pending')}</span>`}
                                </span>
                            </div>
                            <div class="job-info-row">
                                <span class="job-info-label">Contact</span>
                                <span class="job-info-value">
                                    ${job.contact_phone ? `<a href="tel:${job.contact_phone}">${safe(job.contact_name || job.contact_phone)}</a>` : safe(job.contact_name || '-')}
                                </span>
                            </div>
                        </div>
                        <div class="equipment-count">🔧 ${equipment.length} unit${equipment.length !== 1 ? 's' : ''} on site</div>
                        <div class="job-actions" style="flex-wrap: wrap;">
                            ${FC_FLAGS.isOn('invoice_creation') && job.status !== 'completed' ? `<button class="btn btn-primary" onclick="openInvoiceModal('${job.id}')" style="flex: 1; min-width: 100px;">Create Invoice</button>` : ''}
                            <button class="btn btn-outline" onclick="viewHistory('${job.id}')" style="flex: 1; min-width: 100px;">History</button>
                            <button class="btn btn-outline" onclick="openChecklist('${job.id}')" style="flex: 1; min-width: 100px;">📋 Checklist</button>
                            ${hasAddress ? `
                                <div style="position: relative; flex: 1; min-width: 100px;">
                                    <button class="btn btn-navigate" onclick="toggleNavMenu(this)" style="width: 100%; margin: 0;">🧭 Navigate</button>
                                    <div class="nav-menu" style="display: none; position: absolute; top: 100%; right: 0; background: #181530; border: 1px solid #333; border-radius: 8px; margin-top: 4px; z-index: 10; min-width: 150px;">
                                        <button class="nav-menu-item" onclick="openNavApp('google', '${encodeURIComponent((job.address_street||'')+', '+(job.address_city||'')+', '+(job.address_state||'')+' '+(job.address_zip||''))}', '${job.id}')">Google Maps</button>
                                        <button class="nav-menu-item" onclick="openNavApp('apple', '${encodeURIComponent((job.address_street||'')+', '+(job.address_city||'')+', '+(job.address_state||'')+' '+(job.address_zip||''))}', '${job.id}')">Apple Maps</button>
                                        <button class="nav-menu-item" onclick="openNavApp('waze', '${encodeURIComponent((job.address_street||'')+', '+(job.address_city||'')+', '+(job.address_state||'')+' '+(job.address_zip||''))}', '${job.id}')">Waze</button>
                                    </div>
                                </div>
                            ` : `<div style="padding:8px 12px;background:rgba(107,114,128,0.15);color:#888;border:1px solid #444;border-radius:8px;font-size:0.85rem;text-align:center;font-style:italic;flex: 1; min-width: 100px;">⚠️ No Address</div>`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openInvoiceModal(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            const equipment = getEquipmentForJob(jobId);

            selectedPhotos = [];
            selectedVideos = [];
            activeUnits = {};

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().slice(0, 5);

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'invoiceModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Create Invoice</h2>
                        <button class="modal-close" onclick="closeInvoiceModal()" aria-label="Close">×</button>
                    </div>

                    <div class="job-site-info">
                        <div class="job-site-name">${safe(job.job_site_name)}</div>
                        <div class="job-site-address">${safe(job.address_street || '')} ${safe(job.address_city || '')}, ${safe(job.address_state || '')}</div>
                    </div>

                    <div class="section-title">Select Units Serviced</div>
                    <p style="font-size:0.85rem;color:#888;margin-bottom:16px;">Tap each unit you fueled and enter the details</p>

                    <div id="unitsList">
                        ${equipment.length > 0 ? equipment.map(eq => `
                            <div class="unit-card" id="unit-${eq.id}" onclick="toggleUnit('${eq.id}')">
                                <div class="unit-header">
                                    <div class="unit-info">
                                        <div class="unit-checkbox"></div>
                                        <div>
                                            <div class="unit-number">${safe(eq.equipment_number || 'No #')}</div>
                                            <div class="unit-desc">${safe(eq.description || 'No description')}</div>
                                        </div>
                                    </div>
                                    <div class="unit-toggle">Tap to add</div>
                                </div>
                                <div class="unit-fields" onclick="event.stopPropagation()">
                                    <div class="field-row">
                                        <div class="field-group">
                                            <label>Hours</label>
                                            <input type="number" id="hours-${eq.id}" step="0.1" min="0" placeholder="0">
                                            <div class="unit-label">meter</div>
                                        </div>
                                        <div class="field-group">
                                            <label>Diesel</label>
                                            <input type="number" id="diesel-${eq.id}" step="0.1" min="0" placeholder="0">
                                            <div class="unit-label">gallons</div>
                                        </div>
                                        <div class="field-group">
                                            <label>DEF</label>
                                            <input type="number" id="def-${eq.id}" step="0.1" min="0" placeholder="0">
                                            <div class="unit-label">gallons</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : `
                            <div style="padding:30px;text-align:center;color:#666;background:#181530;border-radius:12px;">
                                No equipment added to this job.<br>Contact your vendor to add units.
                            </div>
                        `}
                    </div>

                    <div class="invoice-details">
                        <div class="section-title" style="margin-top:0;">Invoice Details</div>
                        <div class="detail-row">
                            <div class="detail-group">
                                <label>Date</label>
                                <input type="date" id="invoiceDate" value="${dateStr}">
                            </div>
                            <div class="detail-group">
                                <label>Time</label>
                                <input type="time" id="invoiceTime" value="${timeStr}">
                            </div>
                        </div>
                        <div class="detail-group">
                            <label>Field Worker</label>
                            <input type="text" id="workerName" value="${currentUser.name}">
                        </div>
                        <div class="detail-group">
                            <label>Notes (optional)</label>
                            <div id="voiceNotesContainer"></div>
                            <textarea id="invoiceNotes" placeholder="Gate codes, issues, etc..."></textarea>
                        </div>
                    </div>

                    <div class="gps-section">
                        <div class="gps-header">
                            <svg class="gps-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="gps-title">Delivery Location</span>
                        </div>
                        <button type="button" class="gps-button" id="gpsButton" onclick="captureGPSLocation()">
                            <svg class="gps-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Capture Location
                        </button>
                        <div class="gps-status" id="gpsStatus">
                            <div class="gps-coords-label">📍 GPS Coordinates</div>
                            <div class="gps-coords-value" id="gpsCoords"></div>
                            <a class="gps-map-link" id="gpsMapLink" href="#" target="_blank">Open Map</a>
                        </div>
                    </div>

                    <div class="invoice-details" style="margin-top: 20px;">
                        <div class="section-title" style="margin-top:0;">Invoice Details</div>
                        <label class="incident-toggle" onclick="toggleIncident()">
                            <input type="checkbox" id="hasIncident">
                            <div class="toggle-switch"></div>
                            <span style="font-size:0.9rem;">Report an incident</span>
                        </label>

                        <div class="incident-fields" id="incidentFields">
                            <h4>⚠️ Incident Details</h4>
                            <div class="detail-group">
                                <label>What happened?</label>
                                <textarea id="incidentDescription" placeholder="Describe the incident..."></textarea>
                            </div>
                            <div class="detail-group">
                                <label>Photos</label>
                                <div class="file-upload" onclick="document.getElementById('incidentPhotoInput').click()">
                                    <input type="file" id="incidentPhotoInput" accept="image/*" multiple onchange="handlePhotos(event)">
                                    <div class="file-upload-text">📷 Tap to add photos</div>
                                </div>
                                <div class="file-preview" id="photoPreview"></div>
                            </div>
                            <div class="detail-group">
                                <label>Videos</label>
                                <div class="file-upload" onclick="document.getElementById('videoInput').click()">
                                    <input type="file" id="videoInput" accept="video/*" multiple onchange="handleVideos(event)">
                                    <div class="file-upload-text">🎥 Tap to add videos</div>
                                </div>
                                <div class="file-preview" id="videoPreview"></div>
                            </div>
                        </div>
                    </div>

                    <div class="invoice-summary" id="invoiceSummary">
                        <div class="summary-title">Invoice Summary</div>
                        <div class="summary-row">
                            <span class="summary-label">Units Serviced</span>
                            <span class="summary-value" id="summaryUnits">0</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total Diesel</span>
                            <span class="summary-value" id="summaryDiesel">0 gal</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total DEF</span>
                            <span class="summary-value" id="summaryDef">0 gal</span>
                        </div>
                    </div>

                    ${FC_FLAGS.isOn('photo_invoice') ? `<div class="photo-upload-section">
                        <div class="photo-upload-title">
                            <span>📷 Required Photos</span>
                            <span class="photo-required-badge">*</span>
                        </div>
                        <p style="font-size:0.8rem;color:#888;margin-bottom:12px;">Capture photos for meter/gauge readings (required before submission)</p>
                        <div class="camera-button-group">
                            <button type="button" class="camera-button" onclick="openPhotoCapture('meter_before')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                📸 Meter Before
                            </button>
                            <button type="button" class="camera-button" onclick="openPhotoCapture('meter_after')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                📸 Meter After
                            </button>
                            <button type="button" class="camera-button" onclick="openPhotoCapture('equipment')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                📸 Equipment
                            </button>
                        </div>
                        <div id="photoCategoriesContainer"></div>
                        <input type="file" id="photoInput" accept="image/*" multiple capture="environment" class="photo-input-hidden" onchange="handlePhotoCapture(event)">
                    </div>` : ''}

                    ${FC_FLAGS.isOn('signature') ? `<div class="signature-section">
                        <div class="section-title">Site Contact Signature</div>
                        <p style="font-size:0.8rem;color:#888;margin-bottom:10px;">Have the site contact sign below to confirm delivery</p>
                        <button type="button" class="btn btn-primary" style="width:100%;margin-bottom:12px;" onclick="openSignatureModal()">✍️ Capture Signature</button>
                        <div id="signaturePreview" style="display:none;text-align:center;margin-top:12px;">
                            <img id="signatureImg" style="max-width:100%;height:auto;border-radius:8px;border:1px solid #333;">
                            <p style="font-size:0.8rem;color:#34d399;margin-top:8px;">✓ Signature captured</p>
                        </div>
                        <input type="text" id="signerName" placeholder="Signer's name (optional)" style="width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #444;background:#333;color:#ede9fe;font-size:0.85rem;">
                    </div>` : ''}

                    <button class="submit-invoice" id="submitBtn" onclick="submitInvoice('${jobId}')">
                        Create Invoice
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            setTimeout(initSignature, 100);
            setTimeout(initVoiceNotes, 150);
            setTimeout(updatePhotoButtonStates, 200);
        }

        function captureGPSLocation() {
            const gpsButton = document.getElementById('gpsButton');
            const gpsStatus = document.getElementById('gpsStatus');

            if (!navigator.geolocation) {
                gpsButton.className = 'gps-button error';
                gpsStatus.className = 'gps-status show error';
                gpsStatus.innerHTML = '<p class="gps-error-msg">Geolocation not supported by this browser</p>';
                return;
            }

            gpsButton.className = 'gps-button capturing';
            gpsButton.disabled = true;
            gpsButton.innerHTML = '<svg class="gps-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/></svg> Capturing...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    capturedGPS = { latitude, longitude, accuracy };

                    const lat = latitude.toFixed(6);
                    const lng = longitude.toFixed(6);

                    gpsButton.className = 'gps-button success';
                    gpsButton.disabled = true;
                    gpsButton.innerHTML = `<svg class="gps-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12a3 3 0 100-6 3 3 0 000 6z"/><path d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg> Location Captured ✓`;

                    gpsStatus.className = 'gps-status show success';
                    gpsStatus.innerHTML = `
                        <div class="gps-coords-label">📍 GPS Coordinates</div>
                        <div class="gps-coords">
                            <div><strong>Latitude:</strong> ${lat}</div>
                            <div><strong>Longitude:</strong> ${lng}</div>
                            <div style="font-size:0.75rem;color:#666;margin-top:4px;">Accuracy: ±${Math.round(accuracy)}m</div>
                        </div>
                        <a class="gps-map-link" href="https://www.google.com/maps/?q=${lat},${lng}" target="_blank">Open in Google Maps</a>
                    `;

                    showToast(`Location captured: ${lat}, ${lng}`, 'success');
                },
                (error) => {
                    let errorMsg = 'Unable to get location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location permission denied. Enable in browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out';
                            break;
                    }

                    gpsButton.className = 'gps-button error';
                    gpsButton.disabled = false;
                    gpsButton.innerHTML = '<svg class="gps-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Capture Location';

                    gpsStatus.className = 'gps-status show error';
                    gpsStatus.innerHTML = `<p class="gps-error-msg">⚠️ ${errorMsg}</p>`;

                    showToast(errorMsg, 'error');
                }
            );
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModal')?.remove();
            document.body.style.overflow = '';
            selectedPhotos = [];
            selectedVideos = [];
            activeUnits = {};
            capturedGPS = null;
        }

        // ===== VOICE NOTES =====
        let voiceNotesUI = null;

        function initVoiceNotes() {
            const container = document.getElementById('voiceNotesContainer');
            if (!container) return;

            if (voiceNotesUI) voiceNotesUI.destroy();

            voiceNotesUI = new VoiceNotesUI({
                container: container,
                textareaId: 'invoiceNotes',
                appendMode: true,
                onStart: () => {
                    console.log('Voice recording started');
                },
                onStop: (transcript) => {
                    console.log('Voice recording stopped:', transcript);
                }
            });
        }

        // ===== NAVIGATE TO JOB =====
        function navigateToJob(encodedAddress) {
            const address = decodeURIComponent(encodedAddress).replace(/,\s*,/g, ',').replace(/^\s*,|,\s*$/g, '').trim();
            if (!address) { showToast('No address available for this job', 'error'); return; }
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const url = isIOS
                ? `maps://maps.apple.com/?daddr=${encodeURIComponent(address)}`
                : `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
            window.open(url, '_blank');
            showToast('Opening navigation...', 'success');
        }

        // ===== DIGITAL SIGNATURE =====
        let signatureData = null;
        let sigCanvas, sigCtx, sigDrawing = false;

        function initSignature() {
            sigCanvas = document.getElementById('signatureCanvas');
            if (!sigCanvas) return;
            sigCtx = sigCanvas.getContext('2d');
            const rect = sigCanvas.parentElement.getBoundingClientRect();
            sigCanvas.width = rect.width;
            sigCanvas.height = 150;
            sigCtx.strokeStyle = '#333';
            sigCtx.lineWidth = 2;
            sigCtx.lineCap = 'round';
            sigCtx.lineJoin = 'round';

            sigCanvas.addEventListener('pointerdown', sigStart);
            sigCanvas.addEventListener('pointermove', sigMove);
            sigCanvas.addEventListener('pointerup', sigEnd);
            sigCanvas.addEventListener('pointerleave', sigEnd);
        }
        function sigStart(e) {
            sigDrawing = true;
            const r = sigCanvas.getBoundingClientRect();
            sigCtx.beginPath();
            sigCtx.moveTo(e.clientX - r.left, e.clientY - r.top);
            var _sigP = document.getElementById('sigPlaceholder'); if(_sigP) _sigP.style.display = 'none';
        }
        function sigMove(e) {
            if (!sigDrawing) return;
            const r = sigCanvas.getBoundingClientRect();
            sigCtx.lineTo(e.clientX - r.left, e.clientY - r.top);
            sigCtx.stroke();
        }
        function sigEnd() {
            if (sigDrawing) {
                sigDrawing = false;
                signatureData = sigCanvas.toDataURL('image/png');
                var _sigS = document.getElementById('sigStatus'); if(_sigS) _sigS.classList.add('show');
            }
        }
        function clearSignature() {
            if (!sigCanvas) return;
            sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
            signatureData = null;
            var _sigP = document.getElementById('sigPlaceholder'); if(_sigP) _sigP.style.display = 'block';
            var _sigS = document.getElementById('sigStatus'); if(_sigS) _sigS.classList.remove('show');
        }

        function toggleUnit(unitId) {
            const card = document.getElementById(`unit-${unitId}`);
            const isActive = card.classList.contains('active');
            if (isActive) {
                card.classList.remove('active');
                delete activeUnits[unitId];
            } else {
                card.classList.add('active');
                activeUnits[unitId] = true;
            }
            updateSummary();
        }

        function updateSummary() {
            let totalDiesel = 0, totalDef = 0, unitCount = 0;
            Object.keys(activeUnits).forEach(unitId => {
                totalDiesel += parseFloat(document.getElementById(`diesel-${unitId}`)?.value) || 0;
                totalDef += parseFloat(document.getElementById(`def-${unitId}`)?.value) || 0;
                unitCount++;
            });
            var _summ = document.getElementById('summaryUnits'); if(_summ) _summ.textContent = unitCount;
            var _summ = document.getElementById('summaryDiesel'); if(_summ) _summ.textContent = `${totalDiesel.toFixed(1)} gal`;
            var _summ = document.getElementById('summaryDef'); if(_summ) _summ.textContent = `${totalDef.toFixed(1)} gal`;
        }

        document.addEventListener('input', function(e) {
            if (e.target.id?.startsWith('diesel-') || e.target.id?.startsWith('def-')) updateSummary();
        });

        function toggleIncident() {
            const checkbox = document.getElementById('hasIncident');
            const fields = document.getElementById('incidentFields');
            checkbox.checked = !checkbox.checked;
            fields.classList.toggle('show', checkbox.checked);
        }

        function handlePhotos(event) {
            Array.from(event.target.files).forEach(file => { if (file.type.startsWith('image/')) selectedPhotos.push(file); });
            renderPhotoPreview();
        }
        function handleVideos(event) {
            Array.from(event.target.files).forEach(file => { if (file.type.startsWith('video/')) selectedVideos.push(file); });
            renderVideoPreview();
        }
        function renderPhotoPreview() {
            document.getElementById('photoPreview').innerHTML = selectedPhotos.map((file, i) => `
                <div class="file-preview-item">
                    <img src="${URL.createObjectURL(file)}">
                    <button class="remove" onclick="event.stopPropagation();selectedPhotos.splice(${i},1);renderPhotoPreview();">×</button>
                </div>
            `).join('');
        }
        function renderVideoPreview() {
            document.getElementById('videoPreview').innerHTML = selectedVideos.map((file, i) => `
                <div class="file-preview-item">
                    <video src="${URL.createObjectURL(file)}"></video>
                    <button class="remove" onclick="event.stopPropagation();selectedVideos.splice(${i},1);renderVideoPreview();">×</button>
                </div>
            `).join('');
        }

        async function uploadFile(file, folder) {
            const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${file.name}`;
            const filePath = `${folder}/${fileName}`;
            const { error } = await db.storage.from('incidents').upload(filePath, file);
            if (error) return null;
            const { data } = db.storage.from('incidents').getPublicUrl(filePath);
            return data.publicUrl;
        }

        function viewHistory(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            const invoices = getInvoicesForJob(jobId);

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Invoice History</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove();document.body.style.overflow='';" aria-label="Close">×</button>
                    </div>

                    <div class="job-site-info">
                        <div class="job-site-name">${safe(job.job_site_name)}</div>
                        <div class="job-site-address">${safe(job.address_city || '')}, ${safe(job.address_state || '')}</div>
                    </div>

                    <div style="padding:0 0 100px 0;">
                        ${invoices.length ? invoices.map(inv => {
                            const units = inv.units_data || [];
                            return `
                                <div class="history-invoice">
                                    <div class="history-header">
                                        <div>
                                            <div class="history-date">${new Date(inv.invoice_date).toLocaleDateString()}</div>
                                            <div class="history-worker">By ${safe(inv.worker_name)} at ${safe(inv.invoice_time)}</div>
                                        </div>
                                    </div>
                                    <div class="history-units">
                                        ${units.map(u => `
                                            <div class="history-unit">
                                                <div>
                                                    <div class="history-unit-number">${safe(u.unit_number)}</div>
                                                    <div style="font-size:0.8rem;color:#666;">${safe(u.unit_description || '')}</div>
                                                </div>
                                                <div class="history-unit-details">
                                                    <div>⏱ ${u.unit_hours} hrs</div>
                                                    <div>⛽ ${u.diesel_gallons} gal · 💧 ${u.def_gallons} gal</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="history-totals">
                                        <div class="history-total"><div class="history-total-value">${inv.total_diesel}</div><div class="history-total-label">Total Diesel</div></div>
                                        <div class="history-total"><div class="history-total-value">${inv.total_def}</div><div class="history-total-label">Total DEF</div></div>
                                        <div class="history-total"><div class="history-total-value">${units.length}</div><div class="history-total-label">Units</div></div>
                                    </div>
                                    ${inv.notes ? `<div style="padding:12px 16px;font-size:0.85rem;color:#888;border-top:1px solid #333;">📝 ${safe(inv.notes)}</div>` : ''}
                                    ${inv.has_incident ? `
                                        <div class="history-incident">
                                            <div class="history-incident-title">⚠️ Incident Reported</div>
                                            <div class="history-incident-desc">${safe(inv.incident_description || '')}</div>
                                            ${inv.incident_photos?.length ? `<div class="history-incident-media">${inv.incident_photos.map(url => `<img src="${url}" onclick="window.open('${url}','_blank')">`).join('')}</div>` : ''}
                                            ${inv.incident_videos?.length ? `<div class="history-incident-media">${inv.incident_videos.map(url => `<video src="${url}" onclick="window.open('${url}','_blank')"></video>`).join('')}</div>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('') : '<div class="empty">No invoices yet</div>'}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            this.classList.add('active');
            currentTab = this.dataset.tab;
            renderJobs();
        }));

        // ===== PHOTO INVOICE FEATURE =====
        let capturedPhotos = {
          meter_before: [],
          meter_after: [],
          equipment: []
        };

        function openPhotoCapture(category) {
          const input = document.getElementById('photoInput');
          input.dataset.category = category;
          input.click();
        }

        function handlePhotoCapture(event) {
          const category = event.target.dataset.category;
          const files = Array.from(event.target.files);

          // Compress and add photos
          Promise.all(files.map(file => compressImage(file))).then(compressedPhotos => {
            capturedPhotos[category] = [...(capturedPhotos[category] || []), ...compressedPhotos];
            renderPhotoCategories();
            updatePhotoButtonStates();
            showToast(`${files.length} photo(s) added to ${category.replace('_', ' ')}`, 'success');
          });

          // Reset input
          event.target.value = '';
        }

        function compressImage(file) {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Resize to max 1200px width
                const maxWidth = 1200;
                if (width > maxWidth) {
                  height = (maxWidth / width) * height;
                  width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Compress to 80% quality JPEG
                const compressed = canvas.toDataURL('image/jpeg', 0.8);
                resolve({
                  data: compressed,
                  name: file.name,
                  size: compressed.length
                });
              };
              img.src = event.target.result;
            };
          });
        }

        function renderPhotoCategories() {
          const container = document.getElementById('photoCategoriesContainer');
          if (!container) return;

          const categories = [
            { id: 'meter_before', label: 'Meter Before', required: true },
            { id: 'meter_after', label: 'Meter After', required: true },
            { id: 'equipment', label: 'Equipment Photo', required: true }
          ];

          container.innerHTML = categories.map(cat => `
            <div class="photo-category">
              <div class="photo-category-label">
                ${cat.label}
                ${cat.required ? '<span class="photo-category-required">*</span>' : ''}
              </div>
              <div class="photo-grid" id="grid-${cat.id}">
                ${(capturedPhotos[cat.id] || []).map((photo, i) => `
                  <div class="photo-thumbnail">
                    <img src="${photo.data}" alt="Photo">
                    <button type="button" class="photo-thumbnail-delete" onclick="deletePhoto('${cat.id}', ${i})">×</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('');
        }

        function deletePhoto(category, index) {
          capturedPhotos[category].splice(index, 1);
          renderPhotoCategories();
          updatePhotoButtonStates();
          showToast('Photo deleted', 'success');
        }

        function updatePhotoButtonStates() {
          // Update visual state of photo capture buttons based on capturedPhotos
          const categories = ['meter_before', 'meter_after', 'equipment'];

          categories.forEach(category => {
            const btn = document.querySelector(`[onclick*="openPhotoCapture('${category}')"]`);
            if (!btn) return;

            const hasCaptured = capturedPhotos[category] && capturedPhotos[category].length > 0;

            if (hasCaptured) {
              // Visual feedback for captured state
              btn.style.border = '2px solid #34d399';
              btn.style.background = 'rgba(34, 197, 94, 0.1)';
              btn.style.color = '#34d399';

              // Add check mark indicator
              if (!btn.dataset.hasMark) {
                btn.innerHTML = btn.innerHTML.replace('📸', '✅');
                btn.dataset.hasMark = 'true';
              }
            } else {
              // Visual feedback for missing state
              btn.style.border = '';
              btn.style.background = '';
              btn.style.color = '';

              // Remove check mark, restore camera
              if (btn.dataset.hasMark) {
                btn.innerHTML = btn.innerHTML.replace('✅', '📸');
                btn.dataset.hasMark = '';
              }
            }
          });
        }

        function validatePhotos() {
          const required = ['meter_before', 'meter_after', 'equipment'];
          for (const cat of required) {
            if (!capturedPhotos[cat] || capturedPhotos[cat].length === 0) {
              // Improved error message with proper formatting
              const friendlyName = cat.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              showToast(`Please capture the required photo: ${friendlyName}`, 'error');

              // Also try to show fallback alert if toast might not be visible
              const toastContainer = document.querySelector('.toast-container');
              if (!toastContainer || !toastContainer.children.length) {
                alert(`Please capture the required photo: ${friendlyName}`);
              }

              // Highlight the missing photo button visually
              const photoBtn = document.querySelector(`[onclick*="openPhotoCapture('${cat}')"]`);
              if (photoBtn) {
                photoBtn.style.border = '2px solid #f87171';
                photoBtn.style.background = 'rgba(239, 68, 68, 0.1)';
                // Remove highlight after 3 seconds
                setTimeout(() => {
                  photoBtn.style.border = '';
                  photoBtn.style.background = '';
                }, 3000);
              }

              return false;
            }
          }
          return true;
        }

        // ===== ENHANCED SIGNATURE MODAL =====
        let enhancedSignatureData = null;
        let sigModalCanvas, sigModalCtx, sigModalDrawing = false;

        function openSignatureModal() {
          const modal = document.createElement('div');
          modal.className = 'signature-modal';
          modal.id = 'signatureModal';
          modal.innerHTML = `
            <div class="signature-modal-header">
              <h3>✍️ Capture Signature</h3>
              <button class="signature-modal-close" onclick="closeSignatureModal()" aria-label="Close">×</button>
            </div>
            <div class="signature-modal-canvas">
              <canvas id="sigModalCanvas" style="width:100%;height:100%;"></canvas>
            </div>
            <div class="signature-modal-footer">
              <button type="button" class="signature-modal-footer button sig-btn-clear" onclick="clearSignatureModal()">Clear</button>
              <button type="button" class="signature-modal-footer button sig-btn-done" onclick="saveSignatureModal()">Done</button>
            </div>
          `;
          document.body.appendChild(modal);
          document.body.style.overflow = 'hidden';
          setTimeout(initSignatureModal, 50);
        }

        function initSignatureModal() {
          sigModalCanvas = document.getElementById('sigModalCanvas');
          if (!sigModalCanvas) return;

          sigModalCtx = sigModalCanvas.getContext('2d');

          // Set canvas size to match container
          const rect = sigModalCanvas.parentElement.getBoundingClientRect();
          sigModalCanvas.width = rect.width;
          sigModalCanvas.height = rect.height;

          // Setup drawing
          sigModalCtx.strokeStyle = '#333';
          sigModalCtx.lineWidth = 2.5;
          sigModalCtx.lineCap = 'round';
          sigModalCtx.lineJoin = 'round';

          // Determine if touch or mouse
          const isTouchDevice = () => {
            return (('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0));
          };

          if (isTouchDevice()) {
            sigModalCanvas.addEventListener('touchstart', sigModalStart, false);
            sigModalCanvas.addEventListener('touchmove', sigModalMove, false);
            sigModalCanvas.addEventListener('touchend', sigModalEnd, false);
          } else {
            sigModalCanvas.addEventListener('mousedown', sigModalStart, false);
            sigModalCanvas.addEventListener('mousemove', sigModalMove, false);
            sigModalCanvas.addEventListener('mouseup', sigModalEnd, false);
            sigModalCanvas.addEventListener('mouseleave', sigModalEnd, false);
          }

          // Set background to white
          sigModalCtx.fillStyle = '#fff';
          sigModalCtx.fillRect(0, 0, sigModalCanvas.width, sigModalCanvas.height);
        }

        function getSignatureCoords(e) {
          const rect = sigModalCanvas.getBoundingClientRect();
          if (e.touches) {
            return {
              x: e.touches[0].clientX - rect.left,
              y: e.touches[0].clientY - rect.top
            };
          } else {
            return {
              x: e.clientX - rect.left,
              y: e.clientY - rect.top
            };
          }
        }

        function sigModalStart(e) {
          e.preventDefault();
          sigModalDrawing = true;
          const coords = getSignatureCoords(e);
          sigModalCtx.beginPath();
          sigModalCtx.moveTo(coords.x, coords.y);
        }

        function sigModalMove(e) {
          if (!sigModalDrawing) return;
          e.preventDefault();
          const coords = getSignatureCoords(e);
          sigModalCtx.lineTo(coords.x, coords.y);
          sigModalCtx.stroke();
        }

        function sigModalEnd(e) {
          if (sigModalDrawing) {
            e.preventDefault();
            sigModalDrawing = false;
          }
        }

        function clearSignatureModal() {
          if (sigModalCanvas) {
            sigModalCtx.fillStyle = '#fff';
            sigModalCtx.fillRect(0, 0, sigModalCanvas.width, sigModalCanvas.height);
            enhancedSignatureData = null;
          }
        }

        function saveSignatureModal() {
          if (!sigModalCanvas) return;
          enhancedSignatureData = sigModalCanvas.toDataURL('image/png');
          signatureData = enhancedSignatureData;

          // Show preview
          const preview = document.getElementById('signaturePreview');
          if (preview) {
            const img = document.getElementById('signatureImg');
            img.src = enhancedSignatureData;
            preview.style.display = 'block';
          }

          closeSignatureModal();
          showToast('Signature captured successfully!', 'success');
        }

        function closeSignatureModal() {
          const modal = document.getElementById('signatureModal');
          if (modal) modal.remove();
          document.body.style.overflow = '';
          sigModalCanvas = null;
          sigModalCtx = null;
        }

        // ===== SUBMIT INVOICE =====
        async function submitInvoice(jobId) {
          // Photos and signature are optional — don't block submission

          try {
            const unitIds = Object.keys(activeUnits);
            if (unitIds.length === 0) { showToast('Please select at least one unit', 'error'); return; }

            for (const unitId of unitIds) {
              const hours = document.getElementById(`hours-${unitId}`).value;
              const diesel = document.getElementById(`diesel-${unitId}`).value;
              const def = document.getElementById(`def-${unitId}`).value;
              if (!hours || !diesel || !def) { showToast('Fill in hours, diesel, and DEF for all selected units', 'error'); return; }
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Uploading photos...';

            let uploadedPhotos = [], uploadedVideos = [];
            const hasIncident = document.getElementById('hasIncident').checked;

            // Upload incident photos/videos
            if (hasIncident) {
              for (const photo of selectedPhotos) { const url = await uploadFile(photo, 'photos'); if (url) uploadedPhotos.push(url); }
              for (const video of selectedVideos) { const url = await uploadFile(video, 'videos'); if (url) uploadedVideos.push(url); }
            }

            // Upload required photos (compress already done)
            let photosUrlsByCategory = {};
            if (FC_FLAGS.isOn('photo_invoice')) {
              btn.textContent = 'Processing photos...';
              for (const [category, photos] of Object.entries(capturedPhotos)) {
                photosUrlsByCategory[category] = photos.map(p => p.data);
              }
            }

            btn.textContent = 'Saving...';

            const equipment = getEquipmentForJob(jobId);
            const unitsData = unitIds.map(unitId => {
              const eq = equipment.find(e => e.id === unitId);
              return {
                unit_id: unitId,
                unit_number: eq?.equipment_number || '',
                unit_description: eq?.description || '',
                unit_hours: parseFloat(document.getElementById(`hours-${unitId}`).value),
                diesel_gallons: parseFloat(document.getElementById(`diesel-${unitId}`).value),
                def_gallons: parseFloat(document.getElementById(`def-${unitId}`).value)
              };
            });

            const totalDiesel = unitsData.reduce((sum, u) => sum + u.diesel_gallons, 0);
            const totalDef = unitsData.reduce((sum, u) => sum + u.def_gallons, 0);
            const date = document.getElementById('invoiceDate').value;
            const time = document.getElementById('invoiceTime').value;

            let notes = document.getElementById('invoiceNotes').value;
            const signerName = document.getElementById('signerName')?.value || '';
            if (capturedGPS) {
              const gpsString = `GPS: ${capturedGPS.latitude.toFixed(6)}, ${capturedGPS.longitude.toFixed(6)} | `;
              notes = gpsString + (notes || '');
            }
            if (signerName) {
              notes = (notes || '') + ` | Signed by: ${signerName}`;
            }

            const { data, error } = await db.from('invoices').insert([{
              job_id: jobId,
              worker_id: currentUser.id,
              worker_name: document.getElementById('workerName').value,
              invoice_date: date,
              invoice_time: time,
              notes: notes,
              units_data: unitsData,
              total_diesel: totalDiesel,
              total_def: totalDef,
              has_incident: hasIncident,
              incident_description: hasIncident ? document.getElementById('incidentDescription').value : null,
              incident_photos: uploadedPhotos,
              incident_videos: uploadedVideos,
              signature_data: signatureData || null,
              photos_meter_before: photosUrlsByCategory.meter_before || [],
              photos_meter_after: photosUrlsByCategory.meter_after || [],
              photos_equipment: photosUrlsByCategory.equipment || [],
              latitude: capturedGPS?.latitude || null,
              longitude: capturedGPS?.longitude || null,
              location_accuracy: capturedGPS?.accuracy || null
            }]).select().single();

            if (error) {
              console.error('Error:', error);
              showToast('Error creating invoice: ' + error.message, 'error');
              btn.disabled = false;
              btn.textContent = 'Create Invoice';
              return;
            }

            // Save to offline storage if offline
            if (!navigator.onLine && typeof offlineSync !== 'undefined') {
              await offlineSync.saveOfflineInvoice({
                job_id: jobId,
                worker_id: currentUser.id,
                worker_name: document.getElementById('workerName').value,
                invoice_date: date,
                invoice_time: time,
                notes: notes,
                units_data: unitsData,
                total_diesel: totalDiesel,
                total_def: totalDef,
                has_incident: hasIncident,
                incident_description: hasIncident ? document.getElementById('incidentDescription').value : null,
                incident_photos: uploadedPhotos,
                incident_videos: uploadedVideos,
                signature_data: signatureData || null,
                photos_meter_before: photosUrlsByCategory.meter_before || [],
                photos_meter_after: photosUrlsByCategory.meter_after || [],
                photos_equipment: photosUrlsByCategory.equipment || [],
                latitude: capturedGPS?.latitude || null,
                longitude: capturedGPS?.longitude || null,
                location_accuracy: capturedGPS?.accuracy || null
              });
              showToast('Invoice saved offline. Will sync when online.', 'success');
            }

            closeInvoiceModal();
            capturedPhotos = { meter_before: [], meter_after: [], equipment: [] };
            signatureData = null;
            enhancedSignatureData = null;
            loadData();
          } catch (err) {
            console.error('Submit error:', err);
            showToast('Error: ' + (err.message || 'Unknown error'), 'error');
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.textContent = 'Create Invoice';
          }
        }

        loadData();

        // ===== NAVIGATION & CHECKLIST FEATURES =====

        function toggleNavMenu(button) {
            const menu = button.nextElementSibling;
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
                document.addEventListener('click', closeNavMenuOnClickOutside);
            } else {
                menu.style.display = 'none';
                document.removeEventListener('click', closeNavMenuOnClickOutside);
            }
        }

        function closeNavMenuOnClickOutside(e) {
            if (!e.target.closest('.nav-menu') && !e.target.closest('.btn-navigate')) {
                document.querySelectorAll('.nav-menu').forEach(m => m.style.display = 'none');
                document.removeEventListener('click', closeNavMenuOnClickOutside);
            }
        }

        function openNavApp(app, encodedAddress, jobId) {
            const address = decodeURIComponent(encodedAddress).replace(/,\s*,/g, ',').replace(/^\s*,|,\s*$/g, '').trim();
            if (!address) {
                showToast('No address available for this job', 'error');
                return;
            }

            let url = '';
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);

            if (app === 'google') {
                url = isIOS || isAndroid
                    ? `geo:0,0?q=${encodeURIComponent(address)}`
                    : `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
            } else if (app === 'apple') {
                url = `maps://maps.apple.com/?daddr=${encodeURIComponent(address)}`;
            } else if (app === 'waze') {
                url = `https://waze.com/ul?q=${encodeURIComponent(address)}&navigate=yes`;
            }

            if (url) {
                window.open(url, '_blank');
                showToast('Opening navigation...', 'success');
                logAudit('navigate_to_job', 'job', jobId, { app });
            }

            // Close menu
            document.querySelectorAll('.nav-menu').forEach(m => m.style.display = 'none');
        }

        function openChecklist(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            if (!job) {
                showToast('Job not found', 'error');
                return;
            }
            window.location.href = `service-checklist.html?jobId=${encodeURIComponent(jobId)}`;
            logAudit('open_checklist', 'job', jobId, {});
        }
    </script>
    <script>
    // Theme toggle
    (function(){
      var btn = document.querySelector('.theme-toggle');
      if(!btn) return;
      function updateIcon(){
        btn.textContent = document.documentElement.classList.contains('light-mode') ? '☀️' : '🌙';
      }
      updateIcon();
      btn.addEventListener('click', function(){
        document.documentElement.classList.toggle('light-mode');
        localStorage.setItem('fleetconnect-theme',
          document.documentElement.classList.contains('light-mode') ? 'light' : 'dark');
        updateIcon();
      });
    })();
    </script>
<script src="hamburger-menu.js"></script>
<script src="global-search.js"></script>
<script src="notification-center.js"></script>
</body>
</html>

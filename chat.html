<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script>
      // Theme init - prevent flash of wrong theme
      (function(){
        var t = localStorage.getItem('fleetconnect-theme');
        if(t === 'light') document.documentElement.classList.add('light-mode');
      })();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages | FleetConnect</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-deep: #100e20;
            --bg-dark: #181530;
            --bg-card: #181530;
            --bg-input: #14112a;
            --border: #2a2550;
            --text-primary: #ede9fe;
            --text-secondary: #8b85b0;
            --text-muted: #5a5480;
            --accent: #8b5cf6;
            --accent-dim: #7c3aed;
            --accent-glow: rgba(139, 92, 246, 0.15);
            --success: #34d399;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-card: 0 4px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--border);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; overflow: hidden; display: flex; }

        .layout { display: flex; height: 100vh; }

        /* Main Content */

        /* Conversations Panel */
        .conversations-panel { width: 340px; background: var(--bg-deep); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .conversations-header { padding: 20px 16px; border-bottom: 1px solid var(--border); }
        .conversations-header h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; }
        .search-input { width: 100%; padding: 10px 12px 10px 36px; background: var(--bg-input) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E") 8px center no-repeat; background-size: 18px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--text-primary); font-family: 'Poppins', sans-serif; }
        .search-input::placeholder { color: var(--text-muted); }
        .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

        .conversations-list { flex: 1; overflow-y: auto; }
        .conversation-item { padding: 12px 8px; margin: 0 8px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .conversation-item:hover { background: rgba(139, 92, 246, 0.05); }
        .conversation-item.active { background: var(--accent-glow); border-left-color: var(--accent); }

        .conv-title { font-size: 0.95rem; font-weight: 500; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .conv-status { font-size: 0.65rem; text-transform: uppercase; padding: 2px 6px; border-radius: 3px; background: rgba(139, 92, 246, 0.1); color: var(--accent); font-weight: 600; }
        .conv-preview { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .conv-time { font-size: 0.7rem; color: var(--text-muted); }
        .conv-unread { display: inline-block; width: 20px; height: 20px; background: var(--accent); color: var(--bg-deep); border-radius: 50%; font-size: 0.65rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }

        /* Chat Panel */
        .chat-panel { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 16px 24px; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .chat-header h2 { font-size: 1rem; font-weight: 600; margin-bottom: 2px; }
        .chat-header-subtitle { font-size: 0.8rem; color: var(--text-secondary); }

        .chat-messages { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 12px; }
        .chat-empty { text-align: center; color: var(--text-muted); padding: 60px 20px; }
        .chat-empty svg { width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px; }

        .message-group { display: flex; gap: 8px; margin-bottom: 4px; }
        .message-group.own { justify-content: flex-end; }

        .message-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); display: flex; align-items: center; justify-content: center; color: var(--bg-deep); font-weight: 600; font-size: 0.75rem; flex-shrink: 0; }
        .message-content { max-width: 60%; display: flex; flex-direction: column; gap: 2px; }
        .message-bubble { padding: 10px 14px; border-radius: var(--radius-md); word-break: break-word; }
        .message-bubble.received { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .message-bubble.sent { background: var(--accent); color: var(--bg-deep); font-weight: 500; }

        .message-header { font-size: 0.75rem; color: var(--text-secondary); padding: 0 12px; display: flex; align-items: center; gap: 6px; }
        .role-badge { display: inline-block; font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; background: rgba(139, 92, 246, 0.15); color: var(--accent); font-weight: 600; text-transform: uppercase; }
        .message-time { font-size: 0.65rem; color: var(--text-muted); }

        .message-attachment { width: 100%; max-width: 200px; border-radius: var(--radius-md); overflow: hidden; }
        .message-attachment img { width: 100%; height: auto; }

        /* Typing Indicator */
        .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 8px 12px; background: var(--bg-card); border-radius: var(--radius-md); width: fit-content; }
        .typing-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { opacity: 0.3; } 30% { opacity: 1; } }

        /* Input Area */
        .chat-input-area { padding: 16px 24px; border-top: 1px solid var(--border); background: var(--bg-card); display: flex; gap: 12px; align-items: flex-end; }
        .input-wrapper { flex: 1; display: flex; gap: 8px; align-items: flex-end; }
        .message-input { flex: 1; padding: 12px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text-primary); font-family: 'Poppins', sans-serif; font-size: 0.9rem; resize: none; max-height: 100px; transition: all 0.2s; }
        .message-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .message-input::placeholder { color: var(--text-muted); }

        .input-btn { width: 40px; height: 40px; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 18px; }
        .input-btn:hover { background: var(--accent-glow); color: var(--accent); }
        .input-btn.primary { background: var(--accent); color: var(--bg-deep); border-color: var(--accent); font-weight: 600; }
        .input-btn.primary:hover { background: var(--accent-dim); }

        /* Loading */
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(139, 92, 246, 0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile */
        @media (max-width: 768px) {
            .main-content { margin-left: 0; }
            .conversations-panel { display: none; width: 100%; }
            .conversations-panel.open { display: flex; position: fixed; z-index: 999; width: 100%; height: 100%; max-width: none; border-right: none; border-bottom: none; }
            .chat-panel { width: 100%; }
            .message-content { max-width: 80%; }
        }

        .mobile-header { display: none; padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); align-items: center; gap: 12px; }
        .mobile-back-btn { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 20px; }
        

        /* Scrollbar styling */
        .conversations-list::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .conversations-list::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .conversations-list::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.2);
            border-radius: 3px;
        }
    
        /* Light Mode */
        .light-mode { --bg-dark: #f5f5f5; --bg-card: #ffffff; --bg-input: #e8e8e8; --bg-hover: #e8e8e8; --border: #d0d0d0; --text-primary: #100e20; --text-secondary: #555555; --text-muted: #888888; }
        .light-mode .sidebar, .light-mode .admin-sidebar { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .sidebar-logo, .light-mode .admin-sidebar-logo { color: #7c3aed !important; }
        .light-mode .nav-item, .light-mode .admin-nav-item { color: #555555 !important; }
        .light-mode .nav-item:hover, .light-mode .admin-nav-item:hover { background: #e8e8e8 !important; color: #100e20 !important; }
        .light-mode .nav-item.active, .light-mode .admin-nav-item.active { background: rgba(139, 92, 246, 0.15) !important; color: #7c3aed !important; }
        .light-mode .nav-section-title, .light-mode .admin-nav-section { color: #888888 !important; }
        .light-mode .user-menu { background: #e8e8e8 !important; }
        .light-mode .user-name { color: #100e20 !important; }
        .light-mode .header { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .header h1 { color: #100e20 !important; }
        .light-mode .header-subtitle { color: #555555 !important; }
        .light-mode .main, .light-mode .content, .light-mode .admin-main { background: #f5f5f5 !important; }
        .light-mode .card, .light-mode .stat-card, .light-mode .metric-card, .light-mode .admin-card { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .card-title, .light-mode .stat-label { color: #100e20 !important; }
        .light-mode .card-subtitle { color: #555555 !important; }
        .light-mode input, .light-mode textarea, .light-mode select { background: #e8e8e8 !important; border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode input::placeholder, .light-mode textarea::placeholder { color: #888888 !important; }
        .light-mode .form-label, .light-mode label { color: #100e20 !important; }
        .light-mode .badge { background: rgba(139, 92, 246, 0.15) !important; color: #7c3aed !important; }
        .light-mode .btn-secondary { background: #e8e8e8 !important; color: #100e20 !important; border-color: #d0d0d0 !important; }
        .light-mode .btn-secondary:hover { background: #d0d0d0 !important; }
        .light-mode .sidebar-footer, .light-mode .admin-sidebar-footer { border-color: #d0d0d0 !important; }
        .light-mode .logout-btn:hover { background: #e8e8e8 !important; }
        .light-mode table th { background: #e8e8e8 !important; color: #100e20 !important; border-color: #d0d0d0 !important; }
        .light-mode table td { border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode table tr:hover { background: #e8e8e8 !important; }
        .light-mode .modal-overlay { background: rgba(0,0,0,0.3) !important; }
        .light-mode .modal, .light-mode .modal-content { background: #ffffff !important; border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode .notification-bell { color: #555555 !important; }
        .light-mode .search-box, .light-mode .search-input { background: #e8e8e8 !important; border-color: #d0d0d0 !important; color: #100e20 !important; }
        .light-mode .tab, .light-mode .tab-btn { color: #555555 !important; }
        .light-mode .tab.active, .light-mode .tab-btn.active { color: #7c3aed !important; border-color: #7c3aed !important; }
        .light-mode .dropdown, .light-mode .dropdown-menu { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .dropdown-item:hover { background: #e8e8e8 !important; }
        .light-mode .toggle-switch { background: #d0d0d0 !important; }
        .light-mode .toggle-switch.active { background: #7c3aed !important; }
        .light-mode .tooltip { background: #100e20 !important; color: #ffffff !important; }
        .light-mode .progress-bar { background: #e8e8e8 !important; }
        .light-mode .empty-state { color: #555555 !important; }
        .light-mode .filter-bar, .light-mode .toolbar { background: #ffffff !important; border-color: #d0d0d0 !important; }
        .light-mode .chip { background: #e8e8e8 !important; color: #100e20 !important; }
        .light-mode pre, .light-mode code { background: #e8e8e8 !important; color: #100e20 !important; }
        .light-mode .status-badge { border-color: #d0d0d0 !important; }
        .light-mode ::selection { background: #7c3aed; color: #ffffff; }
        .light-mode ::-webkit-scrollbar-track { background: #f5f5f5; }
        .light-mode ::-webkit-scrollbar-thumb { background: #d0d0d0; }
        .light-mode ::-webkit-scrollbar-thumb:hover { background: #bbbbbb; }

/* Duplicate html.light-mode block removed */
        .admin-sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 24px 16px; position: fixed; left: 0; top: 0; height: 100vh; overflow-y: auto; z-index: 99; display: flex; flex-direction: column; }
        .admin-sidebar-logo { font-size: 1.1rem; font-weight: 700; color: var(--admin, #8b5cf6); margin-bottom: 16px; }
        .admin-nav-section { margin-bottom: 24px; }
        .admin-nav-section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted, #888); padding: 0 12px; margin-bottom: 8px; letter-spacing: 0.5px; }
        .admin-nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; color: #8b85b0; text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; cursor: pointer; margin-bottom: 4px; }
        .admin-nav-item:hover { background: var(--bg-hover, #333); color: var(--text-primary, #ede9fe); }
        .admin-nav-item.active { background: rgba(139, 92, 246, 0.15); color: var(--admin, #8b5cf6); }
        .admin-nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
        .admin-sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border, #333); }
        .main-content { flex: 1; margin-left: 260px; }
            /* Mobile */
        .hamburger-menu { display: none; position: fixed; top: 20px; left: 20px; z-index: 100; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 8px; cursor: pointer; width: 40px; height: 40px; }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .admin-sidebar { width: 100%; height: auto; position: relative; left: auto; top: auto; border-right: none; border-bottom: 1px solid var(--border); padding: 12px; margin-bottom: 20px; }
            .main-content { margin-left: 0 !important; }
        }
    
        /* Sidebar actions (bell + theme toggle) */
        /* Sidebar layout fix */
        .admin-sidebar { display: flex; flex-direction: column; }
        .admin-sidebar nav { flex: 1; overflow-y: auto; }

/* ===== AETHER THEME ‚Äî Modern Light SaaS ===== */
:root {
    --bg-page: #f8f9fc;
    --bg-card: #ffffff;
    --bg-input: #f1f3f9;
    --accent: #0066ff;
    --accent-light: #e6f0ff;
    --text-primary: #1a1a2e;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --border: #e5e7eb;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    width: 100%;
    height: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background-color: var(--bg-page);
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ===== TOP NAVIGATION BAR ===== */
.aether-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 56px;
    background-color: var(--bg-card);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 32px;
    gap: 48px;
    z-index: 1000;
    box-shadow: var(--shadow);
}

.aether-navbar-logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 18px;
    color: var(--text-primary);
    text-decoration: none;
    flex-shrink: 0;
}

.aether-navbar-logo svg {
    width: 32px;
    height: 32px;
}

.aether-navbar-center {
    display: flex;
    align-items: center;
    gap: 32px;
    flex: 1;
}

.aether-nav-link {
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    padding: 0 4px;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    position: relative;
}

.aether-nav-link:hover {
    color: var(--accent);
}

.aether-nav-link.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

.aether-dropdown {
    position: relative;
}

.aether-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    min-width: 200px;
    margin-top: 8px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: all 0.2s ease;
    box-shadow: var(--shadow);
    z-index: 1001;
}

.aether-dropdown:hover .aether-dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.aether-dropdown-item {
    display: block;
    width: 100%;
    padding: 10px 16px;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.15s ease;
    border-left: 3px solid transparent;
}

.aether-dropdown-item:hover {
    background-color: var(--bg-input);
    color: var(--accent);
    border-left-color: var(--accent);
}

.aether-navbar-right {
    display: flex;
    align-items: center;
    gap: 24px;
    flex-shrink: 0;
}

.aether-user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.aether-user-avatar:hover {
    box-shadow: 0 2px 8px rgba(0, 102, 255, 0.2);
}

.aether-notification-bell {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background-color: var(--bg-input);
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.aether-notification-bell:hover {
    background-color: var(--accent-light);
    border-color: var(--accent);
}

.aether-notification-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background-color: var(--error);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 11px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Mobile hamburger */
.aether-hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
}

.aether-hamburger span {
    width: 24px;
    height: 2px;
    background-color: var(--text-primary);
    border-radius: 2px;
    transition: all 0.3s ease;
}

/* ===== MAIN CONTENT AREA ===== */
.main-content {
    padding-top: 56px;
    width: 100%;
    min-height: 100vh;
    background-color: var(--bg-page);
}

.content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 32px;
}

/* ===== CARDS ===== */
.card {
    background-color: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow);
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-card, .analytics-card, .table-card, .admin-card, .metric-card {
    background-color: var(--bg-card) !important;
    border: 1px solid var(--border) !important;
    border-radius: 12px !important;
    box-shadow: var(--shadow) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    padding: 24px !important;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.card-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

/* ===== TABLES ===== */
table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background-color: var(--bg-input);
}

th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border);
}

td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

tbody tr:hover {
    background-color: #f0f4ff;
}

/* ===== BUTTONS ===== */
.btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background-color: var(--accent);
    color: white;
}

.btn-primary:hover {
    background-color: #0052cc;
    box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
}

.btn-primary:active {
    transform: translateY(1px);
}

.btn-secondary {
    background-color: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    background-color: #e8ecf7;
    border-color: var(--accent);
}

.btn-danger {
    background-color: var(--error);
    color: white;
}

.btn-danger:hover {
    background-color: #dc2626;
}

.btn-success {
    background-color: var(--success);
    color: white;
}

.btn-success:hover {
    background-color: #059669;
}

.btn-small {
    padding: 6px 12px;
    font-size: 13px;
}

/* ===== FORMS ===== */
.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-primary);
}

input, textarea, select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    background-color: var(--bg-card);
    color: var(--text-primary);
    transition: all 0.2s ease;
}

input::placeholder, textarea::placeholder {
    color: var(--text-muted);
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
}

textarea {
    resize: vertical;
    min-height: 100px;
}

/* ===== STATS ===== */
.stat-value {
    font-size: 32px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 12px 0;
}

.stat-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-trend {
    font-size: 13px;
    font-weight: 500;
    color: var(--success);
    margin-top: 8px;
}

.stat-trend.negative {
    color: var(--error);
}

/* ===== BADGES ===== */
.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.badge-primary {
    background-color: var(--accent-light);
    color: var(--accent);
}

.badge-success {
    background-color: #d1fae5;
    color: var(--success);
}

.badge-warning {
    background-color: #fef3c7;
    color: var(--warning);
}

.badge-error {
    background-color: #fee2e2;
    color: var(--error);
}

.role-badge, .status-badge {
    border-radius: 20px !important;
}

/* ===== MODALS ===== */
.modal {
    background-color: var(--bg-card) !important;
    border: 1px solid var(--border) !important;
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

.modal-header {
    border-bottom: 1px solid var(--border);
    padding: 20px 24px;
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    border-top: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* ===== ALERTS ===== */
.alert {
    padding: 12px 16px;
    border-radius: 8px;
    border-left: 4px solid;
    margin-bottom: 16px;
}

.alert-success {
    background-color: #d1fae5;
    border-left-color: var(--success);
    color: #065f46;
}

.alert-warning {
    background-color: #fef3c7;
    border-left-color: var(--warning);
    color: #78350f;
}

.alert-error {
    background-color: #fee2e2;
    border-left-color: var(--error);
    color: #7f1d1d;
}

.alert-info {
    background-color: var(--accent-light);
    border-left-color: var(--accent);
    color: #003d99;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-page);
}

::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .aether-navbar {
        padding: 0 16px;
        gap: 24px;
    }

    .aether-navbar-center {
        display: none;
    }

    .aether-hamburger {
        display: flex;
    }

    .content-wrapper {
        padding: 16px;
    }

    .aether-dropdown-menu {
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        border-radius: 0;
        min-width: unset;
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
    }

    .aether-dropdown:hover .aether-dropdown-menu {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }
}

/* Remove sidebar styles from Aurora */
.admin-sidebar {
    display: none !important;
}

.sidebar {
    display: none !important;
}

.admin-sidebar-logo {
    display: none !important;
}

.admin-nav-section {
    display: none !important;
}

.admin-nav-item {
    display: none !important;
}

.brand-panel::after {
    content: none !important;
}

/* Remove Aurora theme styling */
body::before {
    display: none !important;
}

.orb, .orb-1, .orb-2 {
    display: none !important;
}
</style>

<style>

/* ===== AURORA THEME ‚Äî Glassmorphism Purple/Teal ===== */
/* Glass card effect */
.stat-card, .analytics-card, .table-card, .admin-card, .metric-card {
    background: rgba(24, 21, 48, 0.6) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    border: 1px solid rgba(139, 92, 246, 0.12) !important;
    border-radius: 16px !important;
}

.admin-nav-item {
    border-radius: 12px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}
.admin-nav-item:hover {
    background: rgba(139, 92, 246, 0.08) !important;
    transform: translateX(4px);
}
.admin-nav-item.active {
    background: rgba(139, 92, 246, 0.15) !important;
    color: #8b5cf6 !important;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.08);
}
.btn-primary, .btn {
    border-radius: 12px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}
.btn-primary:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 30px rgba(139, 92, 246, 0.3) !important;
}
input, textarea, select {
    border-radius: 12px !important;
    transition: all 0.25s ease !important;
}
input:focus, textarea:focus, select:focus {
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15), 0 0 30px rgba(139, 92, 246, 0.05) !important;
}
.modal {
    border-radius: 20px !important;
    background: rgba(24, 21, 48, 0.9) !important;
    backdrop-filter: blur(24px) !important;
    -webkit-backdrop-filter: blur(24px) !important;
    border: 1px solid rgba(139, 92, 246, 0.15) !important;
}
/* Gradient accents */
.brand-panel::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #8b5cf6, #14b8a6, transparent);
}
.header h1, .admin-sidebar-logo {
    background: linear-gradient(135deg, #8b5cf6, #14b8a6) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(16, 14, 32, 0.5); }
::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.5); }
/* Status badges */
.role-badge, .status-badge { border-radius: 20px !important; }
/* Animated background pulse */
body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at 30% 70%, rgba(139, 92, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(20, 184, 166, 0.02) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
    animation: auroraPulse 20s ease-in-out infinite;
}
@keyframes auroraPulse {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(-5%, 5%) scale(1.02); }
    50% { transform: translate(5%, -5%) scale(0.98); }
    75% { transform: translate(-3%, -3%) scale(1.01); }
}

</style>
</head>
<body>
<nav id="aetherNavbar"></nav>

    <div class="layout">
        <!-- Sidebar Navigation -->
            <aside class="admin-sidebar" id="adminSidebar">
        <div class="admin-sidebar-logo">FLEETCONNECT</div>
        <nav id="sidebarNav"></nav>
        <div class="admin-sidebar-footer">
            <div style="padding: 12px; background: var(--bg-hover, #333); border-radius: 8px;">
                <div style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary, #ede9fe); margin-bottom: 4px;" id="adminUserName">Rental User</div>
                <div class="admin-sidebar-role" style="font-size: 0.75rem; color: var(--text-secondary, #888);">Rental Account</div>
                <button onclick="logout()" style="margin-top: 8px; width: 100%; padding: 6px; background: transparent; border: 1px solid #333; color: #888; border-radius: 6px; font-family: 'Poppins', sans-serif; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;">Logout</button>
            </div>
        </div>
    </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Conversations Panel -->
            <div class="conversations-panel" id="conversationsPanel">
                <div class="conversations-header">
                    <h2>Messages</h2>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search conversations...">
                </div>
                <div class="conversations-list" id="conversationsList">
                    <div class="loading"><div class="spinner"></div>Loading conversations...</div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-panel" id="chatPanel">
                <div class="mobile-header">
                    <button class="mobile-back-btn" onclick="closeMobileChat()">‚Üê</button>
                    <div id="chatHeaderContent">Select a conversation</div>
                </div>
                <div class="chat-header" id="chatHeader" style="display: none;">
                    <h2 id="chatTitle">Select a conversation</h2>
                    <p class="chat-header-subtitle" id="chatSubtitle"></p>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-empty">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <p>Select a conversation to start messaging</p>
                    </div>
                </div>
                <div class="chat-input-area" id="chatInputArea" style="display: none;">
                    <div class="input-wrapper">
                        <button class="input-btn" id="attachBtn" title="Attach file">üìé</button>
                        <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                        <button class="input-btn primary" id="sendBtn" title="Send message">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.9429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.05686475 C3.34915502,0.9 2.40734225,0.999940045 1.77946707,1.4715722 C0.994623095,2.10604706 0.837654326,3.0486314 1.15159189,3.99701575 L3.03521743,10.4380088 C3.03521743,10.5951061 3.19218622,10.7521935 3.50612381,10.7521935 L16.6915026,11.5376804 C16.6915026,11.5376804 17.1624089,11.5376804 17.1624089,11.0663883 L17.1624089,12.0089727 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div><!-- end main-content -->
    </div>

    <!-- SQL Schema (for reference) -->
    <script>
    /*
    SQL Schema for messages table:

    CREATE TABLE messages (
      id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
      job_id UUID REFERENCES jobs(id) ON DELETE CASCADE,
      sender_id UUID REFERENCES users(id),
      sender_name TEXT NOT NULL,
      sender_role TEXT NOT NULL,
      content TEXT NOT NULL,
      attachment_url TEXT,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      read_by UUID[] DEFAULT ARRAY[]::uuid[],
      status TEXT DEFAULT 'sent' -- 'sent', 'delivered', 'read'
    );

    CREATE INDEX idx_messages_job_id ON messages(job_id);
    CREATE INDEX idx_messages_created_at ON messages(created_at DESC);
    CREATE INDEX idx_messages_sender_id ON messages(sender_id);
    */
    </script>

    <script src="supabase-client.js"></script>
    <script src="sidebar.js"></script>
    <script src="chat-utils.js"></script>
    <script>
        // Chat page state
        let currentUser = null;
        let selectedJobId = null;
        let conversations = [];
        let messageSubscription = null;
        let allMessages = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            currentUser = checkAuth(['admin', 'vendor', 'rental', 'fieldworker']);
            if (!currentUser) return;

            setupUI();
            loadConversations();
            setupInputHandlers();
        });
        function setupUI() {
            var _un = document.getElementById('adminUserName'); if(_un) _un.textContent = currentUser.name;
            const roleLabelsChat = { admin: 'Administrator', rental: 'Rental Account', vendor: 'Vendor Account', fieldworker: 'Field Worker' };
            var _rl = document.querySelector('.admin-sidebar-role'); if(_rl) _rl.textContent = roleLabelsChat[currentUser.role] || currentUser.role;
        }

        async function loadConversations() {
            const result = await getConversations(currentUser.id, currentUser.role);
            if (!result.success) {
                console.error('Failed to load conversations:', result.error);
                return;
            }

            conversations = result.conversations || [];
            renderConversations();
        }

        function renderConversations() {
            const container = document.getElementById('conversationsList');
            if (conversations.length === 0) {
                container.innerHTML = '<div class="chat-empty" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;"><div style="font-size:3rem;margin-bottom:16px;opacity:0.5;">üí¨</div><h3 style="font-size:1.2rem;font-weight:600;color:var(--text-primary,#ede9fe);margin-bottom:8px;">No conversations yet</h3><p style="font-size:0.9rem;color:var(--text-secondary,#8b85b0);margin-bottom:24px;">Start a conversation with your team</p><button onclick="document.getElementById(\'newConvModal\').style.display=\'flex\'" class="btn btn-primary">+ New Conversation</button></div>';
                return;
            }

            container.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${conv.jobId === selectedJobId ? 'active' : ''}" onclick="selectConversation('${conv.jobId}', '${safe(conv.jobName)}')">
                    <div class="conv-title">
                        ${safe(conv.jobName)}
                        <span class="conv-status">${safe(conv.status)}</span>
                    </div>
                    <div class="conv-preview">${safe(conv.lastMessageAuthor)}: ${safe(conv.lastMessage.substring(0, 40))}...</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="conv-time">${formatMessageTime(conv.lastMessageTime)}</span>
                        ${conv.unreadCount > 0 ? `<span class="conv-unread">${conv.unreadCount}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function selectConversation(jobId, jobName) {
            selectedJobId = jobId;
            var _chat = document.getElementById('chatHeader'); if(_chat) _chat.style.display = 'block';
            var _chat = document.getElementById('chatInputArea'); if(_chat) _chat.style.display = 'flex';
            var _chat = document.getElementById('chatTitle'); if(_chat) _chat.textContent = safe(jobName);
            var _chat = document.getElementById('chatHeaderContent'); if(_chat) _chat.textContent = safe(jobName);
            var _chat = document.getElementById('chatMessages'); if(_chat) _chat.innerHTML = '<div class="loading"><div class="spinner"></div>Loading messages...</div>';

            // Close conversations panel on mobile
            if (window.innerWidth <= 768) {
                var _conv = document.getElementById('conversationsPanel'); if(_conv) _conv.classList.remove('open');
            }

            renderConversations();
            loadMessages();
            setupMessageSubscription();
        }

        async function loadMessages() {
            if (!selectedJobId) return;

            const result = await getMessages(selectedJobId, 50);
            if (!result.success) {
                console.error('Failed to load messages:', result.error);
                return;
            }

            allMessages = result.messages || [];
            renderMessages();

            // Mark messages as read
            await markAsRead(selectedJobId, currentUser.id);
        }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            if (allMessages.length === 0) {
                container.innerHTML = `
                    <div class="chat-empty">
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allMessages.map((msg, idx) => {
                const isOwn = msg.sender_id === currentUser.id;
                const prevMsg = idx > 0 ? allMessages[idx - 1] : null;
                const shouldShowAvatar = !prevMsg || prevMsg.sender_id !== msg.sender_id;

                return `
                    <div class="message-group ${isOwn ? 'own' : ''}">
                        ${!isOwn && shouldShowAvatar ? `
                            <div class="message-avatar">${safe(msg.sender_name).charAt(0).toUpperCase()}</div>
                        ` : '<div style="width: 32px;"></div>'}
                        <div class="message-content">
                            ${!isOwn ? `
                                <div class="message-header">
                                    <strong>${safe(msg.sender_name)}</strong>
                                    <span class="role-badge">${safe(msg.sender_role)}</span>
                                    <span class="message-time">${formatMessageTime(msg.created_at)}</span>
                                </div>
                            ` : `<div class="message-header"><span class="message-time">${formatMessageTime(msg.created_at)}</span></div>`}
                            <div class="message-bubble ${isOwn ? 'sent' : 'received'}">
                                ${msg.attachment_url ? `<img src="${msg.attachment_url}" class="message-attachment" alt="attachment">` : ''}
                                ${safe(msg.content)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function setupMessageSubscription() {
            if (messageSubscription) {
                messageSubscription.unsubscribe();
            }

            messageSubscription = subscribeToMessages(selectedJobId, (event) => {
                if (event.type === 'INSERT') {
                    allMessages.push(event.message);
                    renderMessages();
                } else if (event.type === 'UPDATE') {
                    const idx = allMessages.findIndex(m => m.id === event.message.id);
                    if (idx >= 0) {
                        allMessages[idx] = event.message;
                        renderMessages();
                    }
                }
            });
        }

        function setupInputHandlers() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            });

            sendBtn.addEventListener('click', handleSendMessage);
        }

        async function handleSendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !selectedJobId) return;

            input.disabled = true;
            const result = await sendMessage(selectedJobId, content);

            if (result.success) {
                input.value = '';
                input.style.height = 'auto';
                loadConversations();
            } else {
                alert('Failed to send message: ' + result.error);
            }

            input.disabled = false;
            input.focus();
        }

        function closeMobileChat() {
            selectedJobId = null;
            var _chat = document.getElementById('chatHeader'); if(_chat) _chat.style.display = 'none';
            var _chat = document.getElementById('chatInputArea'); if(_chat) _chat.style.display = 'none';
            var _chat = document.getElementById('chatMessages'); if(_chat) _chat.innerHTML = '<div class="chat-empty" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;"><div style="font-size:3rem;margin-bottom:16px;opacity:0.5;">üëà</div><h3 style="font-size:1.2rem;font-weight:600;color:var(--text-primary,#ede9fe);margin-bottom:8px;">Select a conversation</h3><p style="font-size:0.9rem;color:var(--text-secondary,#8b85b0);">Choose a conversation from the sidebar to start chatting</p></div>';
            if (messageSubscription) {
                messageSubscription.unsubscribe();
                messageSubscription = null;
            }
        }

        // Search conversations
        var _sear = document.getElementById('searchInput'); if(_sear) _sear.addEventListener('input', (e) => {
            const query = e.target.value;
            if (!query) {
                renderConversations();
            } else {
                const filtered = conversations.filter(c =>
                    c.jobName.toLowerCase().includes(query.toLowerCase()) ||
                    c.lastMessage.toLowerCase().includes(query.toLowerCase())
                );
                document.getElementById('conversationsList').innerHTML = filtered.map(conv => `
                    <div class="conversation-item" onclick="selectConversation('${conv.jobId}', '${safe(conv.jobName)}')">
                        <div class="conv-title">
                            ${safe(conv.jobName)}
                            <span class="conv-status">${safe(conv.status)}</span>
                        </div>
                        <div class="conv-preview">${safe(conv.lastMessage.substring(0, 40))}...</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="conv-time">${formatMessageTime(conv.lastMessageTime)}</span>
                        </div>
                    </div>
                `).join('');
            }
        });

        // Mobile menu toggle
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                var _conv = document.getElementById('conversationsPanel'); if(_conv) _conv.classList.remove('open');
                var _sb = document.querySelector('.admin-sidebar'); if(_sb) _sb.classList.remove('open');
            }
        });
    </script>
    
<script src="hamburger-menu.js"></script>
<script src="global-search.js"></script>
<script src="notification-center.js"></script>
    <script src="realtime.js"></script>
    <script src="feature-flags.js"></script>
</body>
</html>
